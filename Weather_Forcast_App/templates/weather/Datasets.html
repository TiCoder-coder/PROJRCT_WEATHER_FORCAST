{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Dá»¯ liá»‡u</title>
  <link rel="stylesheet" href="{% static 'weather/css/Home.css' %}">
  <link rel="stylesheet" href="{% static 'weather/css/Datasets.css' %}?v=9199999998888899988888908_01">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body class="home-page">

  <div class="hubToolbar">
    <div class="hubBrand">
      <span class="hubDot"></span>
      <span class="hubTitle">VN Weather Hub</span>
    </div>

    <div class="hubTabs">
      <a class="hubTab {% if active_tab == 'recent' %}is-active{% endif %}"
         href="{% url 'weather:datasets' %}?tab=recent">
        ğŸ“¦ Bá»™ dá»¯ liá»‡u gáº§n Ä‘Ã¢y
      </a>

      <a class="hubTab {% if active_tab == 'process' %}is-active{% endif %}"
         href="{% url 'weather:datasets' %}?tab=process#process">
        ğŸ§ª Xá»­ lÃ­ dá»¯ liá»‡u
      </a>
    </div>

    <div class="hubActions">
      <button type="button" class="hubBtn hubBtn-ghost" id="btnBackTop">â†© Quay láº¡i</button>
      <a class="hubBtn hubBtn-ghost" href="{% url 'weather:home' %}">ğŸ  Trang chá»§</a>
    </div>

  </div>

  <div class="datasets-wrap">

    <section id="recent"
             class="hubTabPanel {% if active_tab != 'recent' %}is-hidden{% endif %}">

      <div class="datasets-card">
        <div class="datasets-title" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
          <div class="title-block">
            <h1 class="page-title merged">Dá»® LIá»†U ÄÃƒ Gá»˜P (Dá»® LIá»†U CHUNG)</h1>
            <div class="page-sub">CÃ¡c tá»‡p dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c gá»™p vÃ  lÆ°u trá»¯ táº­p trung. Dá»¯ liá»‡u Ä‘Ã£ xá»­ lÃ½ sáºµn sÃ ng Ä‘á»ƒ phÃ¢n tÃ­ch.</div>
            <div class="title-underline merged"></div>
          </div>

          <div class="actions" style="display: flex; gap: 15px; margin-top: 10px;">
            <button type="button" class="pill" id="btnBack">â†© QUAY Láº I</button>
            <a class="pill primary" href="{% url 'weather:home' %}">â† TRANG CHá»¦</a>
          </div>
        </div>

        {% if latest_merged %}
          <div class="latest-bar merged muted latest-card" style="margin: 14px 0 0;">
            <span class="latest-label">ğŸ“… Má»šI NHáº¤T:</span>
            <span class="latest-name" title="{{ latest_merged.name }}">
              <b>{{ latest_merged.name }}</b>
            </span>
            <span class="latest-meta">
              <span class="latest-size">ğŸ“¦ {{ latest_merged.size_mb }} MB</span>
              <span class="latest-time">ğŸ• {{ latest_merged.mtime }}</span>
            </span>
          </div>
        {% else %}
          <div class="latest-bar merged muted" style="font-weight: 700;">ğŸ“­ CHÆ¯A CÃ“ Tá»†P ÄÃƒ Gá»˜P TRONG THÆ¯ Má»¤C MERGE_DATA/</div>
        {% endif %}

        <div class="section-badge merged">ğŸ—‚ï¸ THÆ¯ Má»¤C MERGE_DATA</div>

        {% if merged_items %}
        <table style="margin: 0 25px 35px;">
          <thead>
            <tr>
              <th style="width:170px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">ğŸ“„</span>
                  <span>TÃŠN Tá»†P</span>
                </span>
              </th>

              <th style="width:220px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">ğŸŒ</span>
                  <span>NGUá»’N Dá»® LIá»†U</span>
                </span>
              </th>

              <th style="width:220px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">ğŸ•</span>
                  <span>Cáº¬P NHáº¬T</span>
                </span>
              </th>

              <th style="width:220px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">ğŸ“¦</span>
                  <span>DUNG LÆ¯á»¢NG</span>
                </span>
              </th>

              <th style="width:170px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">âš¡</span>
                  <span>THAO TÃC</span>
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
          {% for f in merged_items %}
            {% if f.name|slice:"-5:" == ".xlsx" or f.name|slice:"-4:" == ".csv" %}
            <tr>
              <td><div class="file-name">{{ f.name }}</div></td>
              <td class="source-cell">
                {% if "merged_vrain_" in f.name %}
                  <span class="source-badge source-vrain">VRAIN</span>
                {% elif "merged_weather" in f.name %}
                  <span class="source-badge source-openweather">OPENWEATHER</span>
                {% else %}
                  <span class="source-badge source-openweather">ÄÃƒ Gá»˜P</span>
                {% endif %}
              </td>
              <td class="time-cell">{{ f.mtime }}</td>
              <td class="size-cell">{{ f.size_mb }} MB</td>
              <td>
                <div class="op-actions">
                  <a class="pill small" href="{% url 'weather:dataset_view' 'merged' f.name %}">ğŸ‘€ XEM</a>
                  <a class="pill small primary" href="{% url 'weather:dataset_download' 'merged' f.name %}">â¬‡ï¸ Táº¢I</a>
                </div>
              </td>
            </tr>
            {% endif %}
          {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <div>CHÆ¯A CÃ“ Dá»® LIá»†U ÄÃƒ Gá»˜P. HÃƒY NHáº¤N NÃšT "ğŸ”— Gá»˜P Dá»® LIá»†U" á» PHáº¦N DÆ¯á»šI.</div>
        </div>
        {% endif %}
      </div>

      <div class="datasets-card">
        <div class="datasets-title" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
          <div class="title-block">
            <h1 class="page-title">Dá»® LIá»†U THÃ” (CHÆ¯A QUA Xá»¬ LÃ) Gáº¦N ÄÃ‚Y</h1>
            <div class="page-sub">Duyá»‡t, xem trÆ°á»›c vÃ  táº£i xuá»‘ng cÃ¡c tá»‡p Ä‘Ã£ thu tháº­p gáº§n nháº¥t. Dá»¯ liá»‡u thÃ´ tá»« cÃ¡c nguá»“n.</div>
            <div class="title-underline"></div>
          </div>


        </div>

        {% if latest_output %}
          <div class="latest-bar output muted latest-card" style="margin: 14px 0 0;">
            <span class="latest-label">ğŸ“… Má»šI NHáº¤T:</span>
            <span class="latest-name" title="{{ latest_output.name }}">
              <b>{{ latest_output.name }}</b>
            </span>
            <span class="latest-meta">
              <span class="latest-size">ğŸ“¦ {{ latest_output.size_mb }} MB</span>
              <span class="latest-time">ğŸ• {{ latest_output.mtime }}</span>
            </span>
          </div>
        {% else %}
          <div class="latest-bar muted" style="font-weight: 700;">ğŸ“­ KHÃ”NG CÃ“ Tá»†P NÃ€O TRONG THÆ¯ Má»¤C OUTPUT/</div>
        {% endif %}

        <div class="section-badge output">ğŸ“ THÆ¯ Má»¤C OUTPUT</div>

        {% if output_items %}
        <table style="margin: 0 25px 35px;">
          <thead>
            <tr>
              <th style="width:170px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">ğŸ“„</span>
                  <span>TÃŠN Tá»†P</span>
                </span>
              </th>

              <th style="width:220px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">ğŸ•</span>
                  <span>Cáº¬P NHáº¬T</span>
                </span>
              </th>

              <th style="width:220px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">ğŸ“¦</span>
                  <span>DUNG LÆ¯á»¢NG</span>
                </span>
              </th>

              <th style="width:170px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">âš¡</span>
                  <span>THAO TÃC</span>
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
          {% for f in output_items %}
            {% if f.name|slice:"-5:" == ".xlsx" or f.name|slice:"-4:" == ".csv" %}
            <tr>
              <td><div class="file-name">{{ f.name }}</div></td>
              <td class="time-cell">{{ f.mtime }}</td>
              <td class="size-cell">{{ f.size_mb }} MB</td>
              <td>
                <div class="op-actions">
                  <a class="pill small" href="{% url 'weather:dataset_view' 'output' f.name %}" style="background: #48bb78; color: white;">ğŸ‘€ XEM</a>
                  <a class="pill small primary" href="{% url 'weather:dataset_download' 'output' f.name %}" style="background: #4299e1; color: white;">â¬‡ï¸ Táº¢I</a>
                </div>
              </td>
            </tr>
            {% endif %}
          {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <div>KHÃ”NG CÃ“ Dá»® LIá»†U NÃ€O TRONG THÆ¯ Má»¤C OUTPUT.</div>
        </div>
        {% endif %}
      </div>

    </section>

    <section id="process"
             class="hubTabPanel {% if active_tab != 'process' %}is-hidden{% endif %}">

      <div class="processing-card">
        <div class="processing-header">
          <div>
            <div class="processing-title">âš™ï¸ THÃ”NG TIN Xá»¬ LÃ Dá»® LIá»†U Gáº¦N ÄÃ‚Y</div>
            <div class="processing-subtitle">
              Quáº£n lÃ½ toÃ n bá»™ quy trÃ¬nh xá»­ lÃ½ dá»¯ liá»‡u tá»« thu tháº­p, gá»™p, lÃ m sáº¡ch Ä‘áº¿n phÃ¢n tÃ­ch. Táº¥t cáº£ trong má»™t giao diá»‡n duy nháº¥t.
            </div>
          </div>
        </div>

        {% with out=output_items|length mer=merged_items|length cln=cleaned_items|length %}
        <div class="quick-stats">
          <div class="stat-card">
            <div class="stat-icon">ğŸ“</div>
            <div class="stat-number">{{ out }}</div>
            <div class="stat-label">FILE THÃ”</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ”—</div>
            <div class="stat-number">{{ mer }}</div>
            <div class="stat-label">FILE ÄÃƒ Gá»˜P</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ§¹</div>
            <div class="stat-number">{{ cln }}</div>
            <div class="stat-label">FILE ÄÃƒ LÃ€M Sáº CH</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-number">{{ cln|add:mer }}</div>
            <div class="stat-label">Tá»”NG FILE Xá»¬ LÃ</div>
          </div>
        </div>
        {% endwith %}

        <div class="processing-grid">
          <div class="processing-box merge-box">
            <div class="box-header">
              <div class="box-icon">ğŸ”—</div>
              <div class="box-title">Gá»˜P Dá»® LIá»†U THÃ”NG MINH</div>
            </div>
            <div class="box-content">
              Tá»± Ä‘á»™ng phÃ¡t hiá»‡n vÃ  gá»™p táº¥t cáº£ file dá»¯ liá»‡u tá»« nhiá»u nguá»“n. Há»— trá»£ CSV/Excelâ€¦ vá»›i kháº£ nÄƒng nháº­n diá»‡n cáº¥u trÃºc.
            </div>
            <div class="box-steps">
              <div class="step-item"><div class="step-number">1</div><div>QuÃ©t vÃ  phÃ¢n tÃ­ch file trong OUTPUT</div></div>
              <div class="step-item"><div class="step-number">2</div><div>Tá»± Ä‘á»™ng cÄƒn chá»‰nh cá»™t dá»¯ liá»‡u</div></div>
              <div class="step-item"><div class="step-number">3</div><div>Gá»™p vÃ  lÆ°u vÃ o MERGE_DATA</div></div>
            </div>
          </div>

          <div class="processing-box clean-box">
            <div class="box-header">
              <div class="box-icon">ğŸ§¹</div>
              <div class="box-title">LÃ€M Sáº CH NÃ‚NG CAO</div>
            </div>
            <div class="box-content">
              Ãp dá»¥ng ká»¹ thuáº­t lÃ m sáº¡ch: missing, duplicates, outliers, normalize, encode, datetime, formatâ€¦
            </div>
            <div class="box-steps">
              <div class="step-item"><div class="step-number">1</div><div>Chá»n nguá»“n dá»¯ liá»‡u cáº§n lÃ m sáº¡ch</div></div>
              <div class="step-item"><div class="step-number">2</div><div>TÃ¹y chá»n ká»¹ thuáº­t lÃ m sáº¡ch</div></div>
              <div class="step-item"><div class="step-number">3</div><div>Xuáº¥t bÃ¡o cÃ¡o chi tiáº¿t</div></div>
            </div>
          </div>

          <div class="processing-box desc-box">
            <div class="box-header">
              <div class="box-icon">ğŸ“–</div>
              <div class="box-title">TÃ€I LIá»†U & HÆ¯á»šNG DáºªN</div>
            </div>
            <div class="box-content">
              Xem quy trÃ¬nh xá»­ lÃ½, ká»¹ thuáº­t Ã¡p dá»¥ng, thÃ´ng sá»‘ ká»¹ thuáº­t vÃ  hÆ°á»›ng dáº«n sá»­ dá»¥ng tÃ­nh nÄƒng.
            </div>
            <div class="box-steps">
              <div class="step-item"><div class="step-number">1</div><div>Quy trÃ¬nh xá»­ lÃ½ dá»¯ liá»‡u</div></div>
              <div class="step-item"><div class="step-number">2</div><div>CÃ¡c ká»¹ thuáº­t lÃ m sáº¡ch</div></div>
              <div class="step-item"><div class="step-number">3</div><div>HÆ°á»›ng dáº«n sá»­ dá»¥ng</div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="datasets-card" style="border: 1px solid rgba(255,255,255,.08);">
        <div class="datasets-title" style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap;">
          <div class="title-block">
            <h1 class="page-title merged">Gá»˜P Dá»® LIá»†U (OUTPUT â†’ MERGE_DATA)</h1>
            <div class="page-sub">
              Gá»™p cÃ¡c file dá»¯ liá»‡u thÃ´ trong <b>OUTPUT</b> thÃ nh bá»™ dá»¯ liá»‡u chung trong <b>MERGE_DATA</b>.
            </div>
            <div class="title-underline merged"></div>
          </div>

          <div class="actions" style="display:flex; gap:15px; margin-top:10px;">
            <button type="button" class="pill merge" id="btnMerge">ğŸ”— Gá»˜P Dá»® LIá»†U</button>
          </div>
        </div>

        {% if latest_output %}
          <div class="latest-bar output muted latest-card" style="margin: 14px 0 0;">
            <span class="latest-label">ğŸ“¦ OUTPUT má»›i nháº¥t:</span>
            <span class="latest-name" title="{{ latest_output.name }}">
              <b>{{ latest_output.name }}</b>
            </span>
            <span class="latest-meta">
              <span class="latest-size">ğŸ“¦ {{ latest_output.size_mb }} MB</span>
              <span class="latest-time">ğŸ• {{ latest_output.mtime }}</span>
            </span>
          </div>
        {% else %}
          <div class="latest-bar muted" style="margin: 14px 0 0; font-weight:700;">
            ğŸ“­ OUTPUT Ä‘ang trá»‘ng â€” chÆ°a cÃ³ gÃ¬ Ä‘á»ƒ gá»™p.
          </div>
        {% endif %}

        <div id="mergeStatus" class="merge-status"></div>

        {% if latest_merged %}
          <div class="latest-bar merged muted latest-card" style="margin: 14px 0 0;">
            <span class="latest-label">âœ… MERGE_DATA má»›i nháº¥t:</span>
            <span class="latest-name" title="{{ latest_merged.name }}">
              <b>{{ latest_merged.name }}</b>
            </span>
            <span class="latest-meta">
              <span class="latest-size">ğŸ“¦ {{ latest_merged.size_mb }} MB</span>
              <span class="latest-time">ğŸ• {{ latest_merged.mtime }}</span>
            </span>
          </div>
        {% endif %}
      </div>

      <div class="datasets-card">
        <div class="datasets-title" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
          <div class="title-block">
            <h1 class="page-title cleaned">LÃ€M Sáº CH Dá»® LIá»†U && Bá»˜ Dá»® LIá»†U ÄÃƒ LÃ€M Sáº CH (Gáº¦N ÄÃ‚Y)</h1>
            <div class="page-sub">Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½, lÃ m sáº¡ch vÃ  chuáº©n hÃ³a tá»« file Ä‘Ã£ gá»™p. Sáºµn sÃ ng cho phÃ¢n tÃ­ch nÃ¢ng cao vÃ  machine learning.</div>
            <div class="title-underline cleaned"></div>
          </div>

          <div class="actions" style="display: flex; gap: 15px; margin-top: 10px;">
            <button type="button" class="pill" id="btnClean">ğŸ§¹ LÃ€M Sáº CH Dá»® LIá»†U</button>
          </div>
        </div>

        <div id="cleanStatus" class="merge-status"></div>

        <div class="section-badge cleaned">ğŸ§¼ Dá»® LIá»†U SAU KHI LÃ€M Sáº CH </div>

        <div class="clean-split">

          <div class="clean-card">
            <div class="clean-card__head">
              <div class="clean-card__title">ğŸ§©Dá»® LIá»†U LÃ€M Sáº CH ÄÃƒ Gá»˜P</div>
              <div class="clean-card__badge">Nguá»“n: Merge_data</div>
            </div>

            {% if latest_cleaned_merge %}
              <div class="latest-bar cleaned muted latest-card" style="margin: 14px 0 0;">
                <span class="latest-label">ğŸ“… Má»šI NHáº¤T:</span>
                <span class="latest-name" title="{{ latest_cleaned_merge.name }}">
                  <b>{{ latest_cleaned_merge.name }}</b>
                </span>
                <span class="latest-meta">
                  <span class="latest-size">ğŸ“¦ {{ latest_cleaned_merge.size_mb }} MB</span>
                  <span class="latest-time">ğŸ• {{ latest_cleaned_merge.mtime }}</span>
                </span>
              </div>
            {% else %}
              <div class="latest-bar cleaned muted" style="margin: 14px 0 0; font-weight:700;">ğŸ“­ ChÆ°a cÃ³ file clean cho MERGE</div>
            {% endif %}

            {% if cleaned_merge_items %}
              <div class="mini-list">
                {% for f in cleaned_merge_items|slice:":6" %}
                  <div class="mini-item">
                    <div class="mini-name">{{ f.name }}</div>
                    <div class="mini-actions">
                      <a class="pill small" href="{% url 'weather:dataset_view' f.folder f.name %}">ğŸ‘€ XEM</a>
                      <a class="pill small primary" href="{% url 'weather:dataset_download' f.folder f.name %}">â¬‡ï¸ Táº¢I</a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state" style="padding: 30px 10px;">
                <div class="empty-state-icon" style="font-size:46px;">ğŸ§©</div>
                <div>ChÆ°a cÃ³ file clean cho nhÃ³m MERGE.</div>
              </div>
            {% endif %}
          </div>

          <div class="clean-card">
            <div class="clean-card__head">
              <div class="clean-card__title">ğŸ“¦ Dá»® LIá»†U LÃ€M Sáº CH CHÆ¯A Gá»˜P</div>
              <div class="clean-card__badge">Nguá»“n: output</div>
            </div>

            {% if latest_cleaned_raw %}
              <div class="latest-bar cleaned muted latest-card" style="margin: 14px 0 0;">
                <span class="latest-label">ğŸ“… Má»šI NHáº¤T:</span>
                <span class="latest-name" title="{{ latest_cleaned_raw.name }}">
                  <b>{{ latest_cleaned_raw.name }}</b>
                </span>
                <span class="latest-meta">
                  <span class="latest-size">ğŸ“¦ {{ latest_cleaned_raw.size_mb }} MB</span>
                  <span class="latest-time">ğŸ• {{ latest_cleaned_raw.mtime }}</span>
                </span>
              </div>
            {% else %}
              <div class="latest-bar cleaned muted" style="margin: 14px 0 0; font-weight:700;">ğŸ“­ ChÆ°a cÃ³ file clean cho OUTPUT</div>
            {% endif %}

            {% if cleaned_raw_items %}
              <div class="mini-list">
                {% for f in cleaned_raw_items|slice:":6" %}
                  <div class="mini-item">
                    <div class="mini-name">{{ f.name }}</div>
                    <div class="mini-actions">
                      <a class="pill small" href="{% url 'weather:dataset_view' 'cleaned_raw' f.name %}" style="background: #48bb78; color: white;">ğŸ‘€ XEM</a>
                      <a class="pill small primary" href="{% url 'weather:dataset_download' 'cleaned_raw' f.name %}" style="background: #4299e1; color: white;">â¬‡ï¸ Táº¢I</a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state" style="padding: 30px 10px;">
                <div class="empty-state-icon" style="font-size:46px;">ğŸ“¦</div>
                <div>ChÆ°a cÃ³ file clean cho nhÃ³m OUTPUT.</div>
              </div>
            {% endif %}
          </div>

        </div>

        <div class="section-badge cleaned">ğŸ“Š Tá»”NG Há»¢P CÃC FILE LÃ€M Sáº CH (Gáº¦N ÄÃ‚Y)</div>

        {% if cleaned_items %}
        <table style="margin: 0 25px 35px;">
          <thead>
            <tr>
              <th style="width:170px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">ğŸ“„</span>
                  <span>TÃŠN Tá»†P</span>
                </span>
              </th>

              <th style="width:220px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">ğŸŒ</span>
                  <span>NGUá»’N Dá»® LIá»†U</span>
                </span>
              </th>

              <th style="width:220px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">ğŸ•</span>
                  <span>Cáº¬P NHáº¬T</span>
                </span>
              </th>

              <th style="width:220px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">ğŸ“¦</span>
                  <span>DUNG LÆ¯á»¢NG</span>
                </span>
              </th>

              <th style="width:170px;" class="th-center">
                <span class="th-inner">
                  <span class="th-ico">âš¡</span>
                  <span>THAO TÃC</span>
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
          {% for f in cleaned_items %}
            {% if f.name|slice:"-4:" == ".csv" or f.name|slice:"-5:" == ".xlsx" %}
            <tr>
              <td><div class="file-name cleaned">{{ f.name }}</div></td>
              <td class="source-cell">
                <span class="source-badge source-cleaned">ÄÃƒ LÃ€M Sáº CH</span>
              </td>
              <td class="time-cell">{{ f.mtime }}</td>
              <td class="size-cell">{{ f.size_mb }} MB</td>
              <td>
                <div class="op-actions">
                  <a class="pill small"
                    href="{% url 'weather:dataset_view' f.folder|default:'cleaned' f.name %}">ğŸ‘€ XEM</a>

                  <a class="pill small primary"
                    href="{% url 'weather:dataset_download' f.folder|default:'cleaned' f.name %}">â¬‡ï¸ Táº¢I</a>
                </div>
              </td>
            </tr>
            {% endif %}
          {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ§¹</div>
          <div>CHÆ¯A CÃ“ Dá»® LIá»†U ÄÃƒ LÃ€M Sáº CH. NHáº¤N NÃšT "ğŸ§¹ LÃ€M Sáº CH Dá»® LIá»†U" Äá»‚ Báº®T Äáº¦U.</div>
        </div>
        {% endif %}
      </div>

    </section>

  </div>

  <div class="cw-overlay" id="cwOverlay" style="display:none;">
    <div class="cw-modal">
      <div class="cw-top">
        <div>
          <div class="cw-title">ğŸ§¼ LÃ€M Sáº CH Dá»® LIá»†U</div>
          <div class="cw-sub">Chá»n nguá»“n â†’ chá»n file â†’ xem tiáº¿n trÃ¬nh â†’ táº£i káº¿t quáº£</div>
        </div>
        <button class="pill" id="cwClose">âœ•</button>
      </div>

      <div class="cw-step" id="cwStep1">
        <div class="cw-grid2">
          <button class="cw-choice" data-source="merge">
            <div class="cw-choice__t">ğŸ§© LÃ€M Sáº CH CHO FILE ÄÃƒ Gá»˜P</div>
            <div class="cw-choice__d">Äá»c tá»« Merge_data â†’ lÆ°u vÃ o Clean_Data_For_File_Merge</div>
          </button>

          <button class="cw-choice" data-source="output">
            <div class="cw-choice__t">ğŸ“¦ LÃ€M Sáº CH CHO FILE CHÆ¯A Gá»˜P</div>
            <div class="cw-choice__d">Äá»c tá»« output â†’ lÆ°u vÃ o Clean_Data_For_File_Not_Merge</div>
          </button>
        </div>
      </div>

      <div class="cw-step" id="cwStep2" style="display:none;">
        <div class="cw-row">
          <div class="cw-pill" id="cwSourceLabel">Nguá»“n: â€”</div>
          <input class="cw-search" id="cwSearch" placeholder="TÃ¬m file..." />
          <button class="pill" id="cwBack">â†© QUAY Láº I</button>
        </div>

        <div class="cw-filelist" id="cwFileList"></div>

        <div class="cw-technique-section">
          <label class="cw-technique-label">ğŸ”§ Chá»n ká»¹ thuáº­t lÃ m sáº¡ch:</label>
          <select id="cwTechnique" class="cw-technique-select">
            <option value="all" selected>ğŸ”¥ Táº¤T Cáº¢ Ká»¸ THUáº¬T (Khuyáº¿n nghá»‹)</option>
            <option value="missing">ğŸ“Š Xá»­ lÃ½ Missing Values</option>
            <option value="duplicates">ğŸ” Loáº¡i bá» Duplicates</option>
            <option value="outliers">ğŸ“ˆ Xá»­ lÃ½ Outliers</option>
            <option value="normalize">âš–ï¸ Chuáº©n hÃ³a dá»¯ liá»‡u (Normalize)</option>
            <option value="encode">ğŸ”¢ MÃ£ hÃ³a dá»¯ liá»‡u (Encode)</option>
            <option value="datetime">ğŸ“… Xá»­ lÃ½ thá»i gian (DateTime)</option>
            <option value="format">âœï¸ Sá»­a lá»—i Ä‘á»‹nh dáº¡ng</option>
          </select>
          <div id="techniqueDescription" class="cw-technique-desc">
            Ãp dá»¥ng táº¥t cáº£ 7 ká»¹ thuáº­t lÃ m sáº¡ch chuyÃªn sÃ¢u cho file Ä‘Ã£ chá»n.
          </div>
        </div>


        <div class="cw-actions">
          <button class="pill" id="cwStart" disabled style="background:linear-gradient(135deg,#48bb78,#38a169);color:#fff;">ğŸš€ Báº®T Äáº¦U LÃ€M Sáº CH</button>
        </div>
      </div>

      <div class="cw-step" id="cwStep3" style="display:none;">
        <div class="cw-progress">
          <div class="cw-bar"><div class="cw-bar__fill" id="cwBarFill" style="width:0%;"></div></div>
          <div class="cw-prow">
            <div class="cw-steptext" id="cwStepText">Äang khá»Ÿi táº¡oâ€¦</div>
            <div class="cw-pct" id="cwPct">0%</div>
          </div>
        </div>

        <div class="cw-log" id="cwLog"></div>
        <div class="cw-report" id="cwReport" style="display:none;"></div>

        <div class="cw-actions">
          <a class="pill" id="cwViewBtn" href="#" style="display:none;background:#48bb78;color:#fff;">ğŸ‘€ XEM NGAY</a>
          <a class="pill primary" id="cwDownloadBtn" href="#" style="display:none;background:#4299e1;color:#fff;">â¬‡ï¸ Táº¢I Vá»€</a>
          <button class="pill" id="cwDone" style="display:none;">âœ… ÄÃ³ng</button>
        </div>
      </div>
    </div>
  </div>

  <div id="mergeResultModal" class="wf-modal" aria-hidden="true">
    <div class="wf-modal__backdrop" data-close="1"></div>

    <div class="wf-modal__panel" role="dialog" aria-modal="true" aria-labelledby="mergeModalTitle">
      <button class="wf-modal__close" type="button" data-close="1">âœ•</button>

      <h3 id="mergeModalTitle">âœ… Gá»˜P Dá»® LIá»†U HOÃ€N Táº¤T</h3>
      <p id="mergeModalMsg" class="wf-modal__msg"></p>

      <div class="wf-modal__file">
        <div class="wf-kv"><span>ğŸ“„ Tá»‡p:</span> <b id="mergeFileName">â€”</b></div>
        <div class="wf-kv"><span>ğŸ“¦ Dung lÆ°á»£ng:</span> <b id="mergeFileSize">â€”</b></div>
        <div class="wf-kv"><span>ğŸ• Cáº­p nháº­t:</span> <b id="mergeFileTime">â€”</b></div>
      </div>

      <div class="wf-modal__actions">
        <a id="mergeViewBtn" class="pill" href="#">ğŸ‘€ XEM</a>
        <a id="mergeDownloadBtn" class="pill primary" href="#">â¬‡ï¸ Táº¢I</a>
        <button class="pill" type="button" data-close="1">âœ– ÄÃ“NG</button>
      </div>
    </div>
  </div>

  <div id="descModal" class="desc-modal" style="display:none;">
    <div class="desc-modal-content">
      <div class="desc-modal-header">
        <div class="desc-modal-title">ğŸ“– TÃ€I LIá»†U HÆ¯á»šNG DáºªN Xá»¬ LÃ Dá»® LIá»†U</div>
        <button class="desc-modal-close" id="descModalClose">âœ•</button>
      </div>
      <div class="desc-modal-body">
        <div class="desc-section">
          <div class="section-title">ğŸ¯ Tá»”NG QUAN Há»† THá»NG</div>
          <div class="section-content">
            Há»‡ thá»‘ng xá»­ lÃ½ dá»¯ liá»‡u Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ quáº£n lÃ½ toÃ n bá»™ vÃ²ng Ä‘á»i dá»¯ liá»‡u tá»« thu tháº­p Ä‘áº¿n phÃ¢n tÃ­ch.
          </div>
        </div>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const btnBackTop = document.getElementById("btnBackTop");

      const btnBack = document.getElementById("btnBack");
      const btnMerge = document.getElementById("btnMerge");
      const btnClean = document.getElementById("btnClean");

      const btnMergeMain = document.getElementById("btnMergeMain");
      if (btnMergeMain && btnMerge) btnMergeMain.addEventListener("click", () => btnMerge.click());

      const btnCleanMain = document.getElementById("btnCleanMain");
      if (btnCleanMain) btnCleanMain.addEventListener("click", cwOpen);

      const descModal = document.getElementById("descModal");
      const btnShowDesc = document.getElementById("btnShowDesc");
      const descModalClose = document.getElementById("descModalClose");

      if (btnShowDesc && descModal) btnShowDesc.addEventListener("click", () => descModal.style.display = "");
      if (descModalClose && descModal) descModalClose.addEventListener("click", () => descModal.style.display = "none");
      if (descModal) descModal.addEventListener("click", (e) => { if (e.target === descModal) descModal.style.display = "none"; });

      const cwTechnique = document.getElementById("cwTechnique");
      const techniqueDescription = document.getElementById("techniqueDescription");

      const TECH_DESC = {
        all: "Ãp dá»¥ng táº¥t cáº£ ká»¹ thuáº­t lÃ m sáº¡ch chuyÃªn sÃ¢u (khuyáº¿n nghá»‹).",
        missing: "Äiá»n/loáº¡i missing values theo chiáº¿n lÆ°á»£c phÃ¹ há»£p.",
        duplicates: "Loáº¡i bá» dÃ²ng trÃ¹ng láº·p theo tiÃªu chÃ­.",
        outliers: "Xá»­ lÃ½ giÃ¡ trá»‹ ngoáº¡i lai (IQR/Z-scoreâ€¦).",
        normalize: "Chuáº©n hÃ³a dá»¯ liá»‡u sá»‘ (min-max/standardizeâ€¦).",
        encode: "MÃ£ hÃ³a biáº¿n phÃ¢n loáº¡i (label/one-hotâ€¦).",
        datetime: "Chuáº©n hÃ³a Ä‘á»‹nh dáº¡ng thá»i gian, tÃ¡ch Ä‘áº·c trÆ°ng ngÃ y-giá»â€¦",
        format: "Sá»­a lá»—i Ä‘á»‹nh dáº¡ng dá»¯ liá»‡u (text/number/unitâ€¦)."
      };

      if (cwTechnique && techniqueDescription) {
        cwTechnique.addEventListener("change", () => {
          techniqueDescription.textContent = TECH_DESC[cwTechnique.value] || "";
        });
      }

      const mergeStatusEl = document.getElementById("mergeStatus");

      function openMergeModal(file, msg){
        const modal = document.getElementById('mergeResultModal');
        if (!modal) return;

        document.getElementById('mergeModalMsg').textContent = msg || 'Gá»™p dá»¯ liá»‡u thÃ nh cÃ´ng!';
        document.getElementById('mergeFileName').textContent = (file && file.name) ? file.name : 'â€”';
        document.getElementById('mergeFileSize').textContent = (file && file.size_mb != null) ? (file.size_mb + ' MB') : 'â€”';
        document.getElementById('mergeFileTime').textContent = (file && file.mtime) ? file.mtime : 'â€”';

        const viewBtn = document.getElementById('mergeViewBtn');
        const dlBtn = document.getElementById('mergeDownloadBtn');
        viewBtn.href = (file && file.view_url) ? file.view_url : '#';
        dlBtn.href = (file && file.download_url) ? file.download_url : '#';

        modal.classList.add('wf-modal--open');
        modal.setAttribute('aria-hidden', 'false');
      }

      function closeMergeModal(){
        const modal = document.getElementById('mergeResultModal');
        if (!modal) return;
        modal.classList.remove('wf-modal--open');
        modal.setAttribute('aria-hidden', 'true');
        window.location.reload();
      }

      document.addEventListener('click', (e) => {
        if (e.target && e.target.closest('#mergeResultModal [data-close]')) {
          closeMergeModal();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeMergeModal();
      });

      if (btnBack) {
        btnBack.addEventListener("click", function () {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = "{% url 'weather:home' %}";
          }
        });
      }

      if (btnBackTop) {
        btnBackTop.addEventListener("click", function () {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = "{% url 'weather:home' %}";
          }
        });
      }


      if (btnMerge) {
        btnMerge.addEventListener("click", async function () {
          btnMerge.disabled = true;
          btnMerge.innerHTML = "â³ ÄANG Gá»˜P...";
          btnMerge.style.background = "linear-gradient(135deg, #718096, #4a5568)";

          showStatus("ÄANG Xá»¬ LÃ Gá»˜P Dá»® LIá»†U... VUI LÃ’NG CHá»œ", "processing", mergeStatusEl);

          try {
            const res = await fetch("{% url 'weather:merge_data' %}", {
              method: "POST",
              headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest"
              }
            });

            const data = await res.json();

            if (data.success) {
              showStatus(data.message || "âœ… Gá»˜P Dá»® LIá»†U THÃ€NH CÃ”NG!", "success", mergeStatusEl);

              if (data.latest_merged) {
                openMergeModal(data.latest_merged, data.message);
              } else {
                setTimeout(() => window.location.reload(), 1200);
              }

            } else {
              showStatus("âŒ " + (data.message || "CÃ“ Lá»–I Xáº¢Y RA KHI Gá»˜P Dá»® LIá»†U"), "error", mergeStatusEl);

              if (data.latest_merged) {
                openMergeModal(data.latest_merged, data.message);
              }

              btnMerge.disabled = false;
              btnMerge.innerHTML = "ğŸ”— Gá»˜P Dá»® LIá»†U";
              btnMerge.style.background = "linear-gradient(135deg, #9f7aea, #805ad5)";
            }

          } catch (err) {
            showStatus("âŒ Lá»–I Káº¾T Ná»I: " + err.message, "error", mergeStatusEl);
            btnMerge.disabled = false;
            btnMerge.innerHTML = "ğŸ”— Gá»˜P Dá»® LIá»†U";
            btnMerge.style.background = "linear-gradient(135deg, #9f7aea, #805ad5)";
          } finally {
            btnMerge.disabled = false;
          }
        });
      }

      const CLEAN_LIST_URL = "{% url 'weather:clean_list' %}";
      const CLEAN_START_URL = "{% url 'weather:clean_data' %}";
      const CLEAN_TAIL_URL = "{% url 'weather:clean_tail' %}";

      const cwOverlay = document.getElementById("cwOverlay");
      const cwClose = document.getElementById("cwClose");
      const cwStep1 = document.getElementById("cwStep1");
      const cwStep2 = document.getElementById("cwStep2");
      const cwStep3 = document.getElementById("cwStep3");

      const cwSourceLabel = document.getElementById("cwSourceLabel");
      const cwSearch = document.getElementById("cwSearch");
      const cwBack = document.getElementById("cwBack");
      const cwFileList = document.getElementById("cwFileList");
      const cwStart = document.getElementById("cwStart");

      const cwBarFill = document.getElementById("cwBarFill");
      const cwStepText = document.getElementById("cwStepText");
      const cwPct = document.getElementById("cwPct");
      const cwLog = document.getElementById("cwLog");
      const cwReport = document.getElementById("cwReport");
      const cwViewBtn = document.getElementById("cwViewBtn");
      const cwDownloadBtn = document.getElementById("cwDownloadBtn");
      const cwDone = document.getElementById("cwDone");

      let cwSource = null;
      let cwFiles = [];
      let cwSelected = null;
      let cwJobId = null;
      let cwSince = 0;
      let cwTimer = null;

      function cwShowStep(n){
        cwStep1.style.display = (n===1) ? "" : "none";
        cwStep2.style.display = (n===2) ? "" : "none";
        cwStep3.style.display = (n===3) ? "" : "none";
      }

      function cwOpen(){
        cwOverlay.style.display = "";
        cwShowStep(1);
        cwSource = null;
        cwFiles = [];
        cwSelected = null;
        cwFileList.innerHTML = "";
        cwStart.disabled = true;
        cwLog.textContent = "";
        cwReport.style.display = "none";
        cwViewBtn.style.display = "none";
        cwDownloadBtn.style.display = "none";
        cwDone.style.display = "none";
        if (cwTimer) clearInterval(cwTimer);
        cwTimer = null;
      }

      function cwCloseModal(){
        cwOverlay.style.display = "none";
        if (cwTimer) clearInterval(cwTimer);
        cwTimer = null;
      }

      if (btnClean) btnClean.addEventListener("click", cwOpen);
      if (cwClose) cwClose.addEventListener("click", cwCloseModal);
      if (cwOverlay) cwOverlay.addEventListener("click", (e) => { if (e.target === cwOverlay) cwCloseModal(); });

      function cwRender(list){
        cwFileList.innerHTML = "";
        if (!list.length){
          cwFileList.innerHTML = `<div class="cw-empty">ğŸ“­ KhÃ´ng cÃ³ file trong thÆ° má»¥c nÃ y.</div>`;
          return;
        }
        list.forEach((f) => {
          const row = document.createElement("label");
          row.className = "cw-file";
          row.innerHTML = `
            <input type="radio" name="cwFile" value="${f.name}">
            <div class="cw-file__main">
              <div class="cw-file__name">${f.name}</div>
              <div class="cw-file__meta">ğŸ“¦ ${f.size_mb} MB â€¢ ğŸ• ${f.mtime}</div>
            </div>
            <div class="cw-file__ext">${(f.ext || "").replace(".","").toUpperCase()}</div>
          `;
          row.querySelector("input").addEventListener("change", () => {
            cwSelected = f.name;
            cwStart.disabled = false;
          });
          cwFileList.appendChild(row);
        });
      }

      async function cwLoadList(source){
        cwSource = source;
        cwSelected = null;
        cwStart.disabled = true;

        cwSourceLabel.textContent = "Nguá»“n: " + (source === "merge" ? "Merge_data (Ä‘Ã£ gá»™p)" : "output (chÆ°a gá»™p)");
        cwShowStep(2);
        cwFileList.innerHTML = `<div class="cw-empty">â³ Äang táº£i danh sÃ¡ch fileâ€¦</div>`;

        const res = await fetch(`${CLEAN_LIST_URL}?source=${encodeURIComponent(source)}`);
        const data = await res.json();
        if (!data.ok){
          cwFileList.innerHTML = `<div class="cw-empty">âŒ ${data.message || "Lá»—i táº£i danh sÃ¡ch"}</div>`;
          return;
        }
        cwFiles = data.files || [];
        cwRender(cwFiles);
      }

      cwStep1.querySelectorAll(".cw-choice").forEach(btn => {
        btn.addEventListener("click", () => cwLoadList(btn.dataset.source));
      });

      cwBack.addEventListener("click", () => cwShowStep(1));

      cwSearch.addEventListener("input", () => {
        const q = (cwSearch.value || "").toLowerCase().trim();
        const filtered = cwFiles.filter(x => x.name.toLowerCase().includes(q));
        cwRender(filtered);
      });

      cwStart.addEventListener("click", async () => {
        if (!cwSource || !cwSelected) return;

        cwShowStep(3);
        cwBarFill.style.width = "0%";
        cwStepText.textContent = "Äang khá»Ÿi táº¡oâ€¦";
        cwPct.textContent = "0%";
        cwLog.textContent = "";
        cwReport.style.display = "none";
        cwViewBtn.style.display = "none";
        cwDownloadBtn.style.display = "none";
        cwDone.style.display = "none";

        const res = await fetch(CLEAN_START_URL, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            source: cwSource,
            filename: cwSelected,
            technique: (cwTechnique ? cwTechnique.value : "all")
          })

        });

        const data = await res.json();
        if (!data.ok){
          cwLog.textContent = "âŒ " + (data.message || "KhÃ´ng start Ä‘Æ°á»£c job");
          cwDone.style.display = "";
          return;
        }

        cwJobId = data.job_id;
        cwSince = 0;

        cwTimer = setInterval(async () => {
          const r = await fetch(`${CLEAN_TAIL_URL}?job_id=${encodeURIComponent(cwJobId)}&since=${cwSince}`);
          const t = await r.json();
          if (!t.ok) return;

          const p = t.progress || {pct:0, step:""};
          cwBarFill.style.width = (p.pct || 0) + "%";
          cwPct.textContent = (p.pct || 0) + "%";
          cwStepText.textContent = p.step || "Äang cháº¡yâ€¦";

          const lines = t.lines || [];
          if (lines.length){
            cwLog.textContent += (cwLog.textContent ? "\n" : "") + lines.join("\n");
            cwLog.scrollTop = cwLog.scrollHeight;
            cwSince = t.next_since || cwSince;
          }

          if (t.done){
            clearInterval(cwTimer);
            cwTimer = null;

            if (t.error){
              cwLog.textContent += "\n\nâŒ " + t.error;
              cwDone.style.display = "";
              return;
            }

            const rsl = t.result || {};
            const rep = rsl.report || {};

            cwReport.style.display = "";
            cwReport.innerHTML = `
              <div class="cw-rgrid">
                <div class="cw-ritem"><div class="cw-rl">Input</div><div class="cw-rv">${rsl.input_file || "-"}</div></div>
                <div class="cw-ritem"><div class="cw-rl">Output</div><div class="cw-rv">${rsl.output_file || "-"}</div></div>
                <div class="cw-ritem"><div class="cw-rl">Rows</div><div class="cw-rv">${rep.rows_before || 0} â†’ ${rep.rows_after || 0}</div></div>
                <div class="cw-ritem"><div class="cw-rl">Missing</div><div class="cw-rv">${rep.missing_before || 0} â†’ ${rep.missing_after || 0}</div></div>
                <div class="cw-ritem"><div class="cw-rl">Dup removed</div><div class="cw-rv">${rep.duplicates_removed || 0}</div></div>
                <div class="cw-ritem"><div class="cw-rl">Size</div><div class="cw-rv">${rsl.size_mb || "-"} MB</div></div>
              </div>
            `;

            if (rsl.view_url){
              cwViewBtn.href = rsl.view_url;
              cwViewBtn.style.display = "";
            }
            if (rsl.download_url){
              cwDownloadBtn.href = rsl.download_url;
              cwDownloadBtn.style.display = "";
            }
            cwDone.style.display = "";
          }
        }, 800);
      });

      cwDone.addEventListener("click", () => {
        cwCloseModal();
        window.location.reload();
      });

      function showStatus(message, type, element) {
        if (!element) return;
        element.textContent = message;
        element.className = "merge-status show " + type;

        if (type !== "processing") {
          setTimeout(() => {
            element.classList.remove("show");
          }, 5000);
        }
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    });
  </script>

  <div class="wx-layer wx-clouds" aria-hidden="true"></div>
  <div class="wx-layer wind-layer" aria-hidden="true"></div>
  <div class="wx-layer wx-rain" aria-hidden="true"></div>
  <div class="wx-layer wx-lightning" aria-hidden="true"></div>
  <div class="wx-lightning-2" aria-hidden="true"></div>
  <div class="wx-thunder-flash" aria-hidden="true"></div>
  <div class="wx-lightning-particle" aria-hidden="true"></div>

</body>
</html>
