{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Qu·∫£n l√Ω D·ªØ li·ªáu</title>
  <link rel="stylesheet" href="{% static 'weather/css/Home.css' %}">
  <link rel="stylesheet" href="{% static 'weather/css/Datasets.css' %}?v=9199999998888899988888908_01">
  <link rel="stylesheet" href="{% static 'weather/css/Datasets_inline.css' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body class="home-page">
  <!-- Tabs Container -->
  <div class="tabs-container">
    <div class="tabs-header">
      <div class="tabs-left">
        <button class="tab-button active" data-tab="tab1">
          <span>üìÅ</span>
          D·ªÆ LI·ªÜU ƒê√É X·ª¨ L√ù
        </button>
        <button class="tab-button" data-tab="tab2">
          <span>‚öôÔ∏è</span>
          TRUNG T√ÇM X·ª¨ L√ù
        </button>
      </div>

      <div class="tabs-right header-actions">
        <button type="button" class="pill" id="btnBack">‚Ü© QUAY L·∫†I</button>
        <a class="pill primary" href="{% url 'weather:home' %}">‚Üê TRANG CH·ª¶</a>
      </div>
    </div>
    
    <!-- Tab 1: D·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω -->
    <div id="tab1" class="tab-content active">
      <div class="datasets-wrap">
        
        <!-- CARD D·ªÆ LI·ªÜU ƒê√É G·ªòP -->
        <div class="datasets-card">
          <div class="datasets-title">
            <div class="title-block">
              <h1 class="page-title merged">D·ªÆ LI·ªÜU ƒê√É G·ªòP (D·ªÆ LI·ªÜU CHUNG)</h1>
              <div class="page-sub">C√°c t·ªáp d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ªôp v√† l∆∞u tr·ªØ t·∫≠p trung. D·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω s·∫µn s√†ng ƒë·ªÉ ph√¢n t√≠ch.</div>
              <div class="title-underline merged"></div>
            </div>

            <div class="actions">
              <!-- Back/Home moved to header to keep controls on the same row as tabs -->
            </div>
          </div>

          {% if latest_merged %}
            <div class="latest-bar cleaned muted latest-card">
              <span class="latest-label">üìÖ M·ªöI NH·∫§T:</span>
              <span class="latest-name" title="{{ latest_merged.name }}">
                <b>{{ latest_merged.name }}</b>
              </span>
              <span class="latest-meta">
                <span class="latest-size">üì¶ {{ latest_merged.size_mb }} MB</span>
                <span class="latest-time">üïê {{ latest_merged.mtime }}</span>
              </span>
            </div>
          {% else %}
            <div class="latest-bar merged muted" style="font-weight: 700; color: #4a5568;">üì≠ CH∆ØA C√ì T·ªÜP ƒê√É G·ªòP TRONG TH∆Ø M·ª§C MERGE_DATA/</div>
          {% endif %}

          <div class="section-badge merged">üóÇÔ∏è TH∆Ø M·ª§C MERGE_DATA</div>

          {% if merged_items %}
          <table>
            <thead>
              <tr>
                <th style="width:25%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">üìÑ</span>
                    <span>T√äN T·ªÜP</span>
                  </span>
                </th>

                <th style="width:20%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">üåê</span>
                    <span>NGU·ªíN D·ªÆ LI·ªÜU</span>
                  </span>
                </th>

                <th style="width:20%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">üïê</span>
                    <span>C·∫¨P NH·∫¨T</span>
                  </span>
                </th>

                <th style="width:15%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">üì¶</span>
                    <span>DUNG L∆Ø·ª¢NG</span>
                  </span>
                </th>

                <th style="width:20%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">‚ö°</span>
                    <span>THAO T√ÅC</span>
                  </span>
                </th>
              </tr>
            </thead>
            <tbody>
            {% for f in merged_items %}
              {% if f.name|slice:"-5:" == ".xlsx" or f.name|slice:"-4:" == ".csv" %}
              <tr>
                <td><div class="file-name">{{ f.name }}</div></td>
                <td class="source-cell">
                  {% if "merged_vrain_" in f.name %}
                    <span class="source-badge source-vrain">VRAIN</span>
                  {% elif "merged_weather" in f.name %}
                    <span class="source-badge source-openweather">OPENWEATHER</span>
                  {% else %}
                    <span class="source-badge source-openweather">ƒê√É G·ªòP</span>
                  {% endif %}
                </td>
                <td class="time-cell">{{ f.mtime }}</td>
                <td class="size-cell">{{ f.size_mb }} MB</td>
                <td>
                  <div class="op-actions">
                    <a class="pill small" href="{% url 'weather:dataset_view' 'merged' f.name %}">üëÄ XEM</a>
                    <a class="pill small primary" href="{% url 'weather:dataset_download' 'merged' f.name %}">‚¨áÔ∏è T·∫¢I</a>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div>CH∆ØA C√ì D·ªÆ LI·ªÜU ƒê√É G·ªòP. H√ÉY NH·∫§N N√öT "üîó G·ªòP D·ªÆ LI·ªÜU" ·ªû TAB TRUNG T√ÇM X·ª¨ L√ù.</div>
          </div>
          {% endif %}
        </div>

        <!-- CARD L√ÄM S·∫†CH D·ªÆ LI·ªÜU -->
        <div class="datasets-card">
          <div class="datasets-title">
            <div class="title-block">
              <h1 class="page-title cleaned">L√ÄM S·∫†CH D·ªÆ LI·ªÜU & B·ªò D·ªÆ LI·ªÜU ƒê√É L√ÄM S·∫†CH</h1>
              <div class="page-sub">D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω, l√†m s·∫°ch v√† chu·∫©n h√≥a t·ª´ file ƒë√£ g·ªôp. S·∫µn s√†ng cho ph√¢n t√≠ch n√¢ng cao v√† machine learning.</div>
              <div class="title-underline cleaned"></div>
            </div>

            <div class="actions">
              <button type="button" class="pill" id="btnClean">üßπ B·∫ÆT ƒê·∫¶U L√ÄM S·∫†CH</button>
            </div>
          </div>

          <div id="cleanStatus" class="merge-status"></div>

          <div class="section-badge cleaned">üßº D·ªÆ LI·ªÜU SAU KHI L√ÄM S·∫†CH</div>

          <div class="clean-split">
            <div class="clean-card">
              <div class="clean-card__head">
                <div class="clean-card__title">üß© D·ªÆ LI·ªÜU L√ÄM S·∫†CH ƒê√É G·ªòP</div>
                <div class="clean-card__badge">Ngu·ªìn: Merge_data</div>
              </div>

              {% if latest_cleaned_merge %}
                <div class="latest-bar cleaned muted latest-card">
                  <span class="latest-label">üìÖ M·ªöI NH·∫§T:</span>
                  <span class="latest-name" title="{{ latest_cleaned_merge.name }}">
                    <b>{{ latest_cleaned_merge.name }}</b>
                  </span>
                  <span class="latest-meta">
                    <span class="latest-size">üì¶ {{ latest_cleaned_merge.size_mb }} MB</span>
                    <span class="latest-time">üïê {{ latest_cleaned_merge.mtime }}</span>
                  </span>
                </div>
              {% else %}
                <div class="latest-bar cleaned muted" style="margin: 14px 0 0; font-weight:700; color: #4a5568;">üì≠ Ch∆∞a c√≥ file clean cho MERGE</div>
              {% endif %}

              {% if cleaned_merge_items %}
                <div class="mini-list">
                  {% for f in cleaned_merge_items|slice:":6" %}
                    <div class="mini-item">
                      <div class="mini-name">{{ f.name }}</div>
                      <div class="mini-actions">
                        <a class="pill small" href="{% url 'weather:dataset_view' f.folder f.name %}">üëÄ XEM</a>
                        <a class="pill small primary" href="{% url 'weather:dataset_download' f.folder f.name %}">‚¨áÔ∏è T·∫¢I</a>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="empty-state" style="padding: 30px 10px;">
                  <div class="empty-state-icon" style="font-size:46px;">üß©</div>
                  <div>Ch∆∞a c√≥ file clean cho nh√≥m MERGE.</div>
                </div>
              {% endif %}
            </div>

            <div class="clean-card">
              <div class="clean-card__head">
                <div class="clean-card__title">üì¶ D·ªÆ LI·ªÜU L√ÄM S·∫†CH CH∆ØA G·ªòP</div>
                <div class="clean-card__badge">Ngu·ªìn: output</div>
              </div>

              {% if latest_cleaned_raw %}
                <div class="latest-bar cleaned muted latest-card">
                  <span class="latest-label">üìÖ M·ªöI NH·∫§T:</span>
                  <span class="latest-name" title="{{ latest_cleaned_raw.name }}">
                    <b>{{ latest_cleaned_raw.name }}</b>
                  </span>
                  <span class="latest-meta">
                    <span class="latest-size">üì¶ {{ latest_cleaned_raw.size_mb }} MB</span>
                    <span class="latest-time">üïê {{ latest_cleaned_raw.mtime }}</span>
                  </span>
                </div>
              {% else %}
                <div class="latest-bar cleaned muted" style="margin: 14px 0 0; font-weight:700; color: #4a5568;">üì≠ Ch∆∞a c√≥ file clean cho OUTPUT</div>
              {% endif %}

              {% if cleaned_raw_items %}
                <div class="mini-list">
                  {% for f in cleaned_raw_items|slice:":6" %}
                    <div class="mini-item">
                      <div class="mini-name">{{ f.name }}</div>
                      <div class="mini-actions">
                        <a class="pill small" href="{% url 'weather:dataset_view' 'cleaned_raw' f.name %}" style="background: #48bb78; color: white;">üëÄ XEM</a>
                        <a class="pill small primary" href="{% url 'weather:dataset_download' 'cleaned_raw' f.name %}" style="background: #4299e1; color: white;">‚¨áÔ∏è T·∫¢I</a>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="empty-state" style="padding: 30px 10px;">
                  <div class="empty-state-icon" style="font-size:46px;">üì¶</div>
                  <div>Ch∆∞a c√≥ file clean cho nh√≥m OUTPUT.</div>
                </div>
              {% endif %}
            </div>
          </div>

          <div class="section-badge cleaned">üìä T·ªîNG H·ª¢P C√ÅC FILE L√ÄM S·∫†CH (G·∫¶N ƒê√ÇY)</div>

          {% if cleaned_items %}
          <table>
            <thead>
              <tr>
                <th style="width:25%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">üìÑ</span>
                    <span>T√äN T·ªÜP</span>
                  </span>
                </th>

                <th style="width:20%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">üåê</span>
                    <span>NGU·ªíN D·ªÆ LI·ªÜU</span>
                  </span>
                </th>

                <th style="width:20%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">üïê</span>
                    <span>C·∫¨P NH·∫¨T</span>
                  </span>
                </th>

                <th style="width:15%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">üì¶</span>
                    <span>DUNG L∆Ø·ª¢NG</span>
                  </span>
                </th>

                <th style="width:20%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">‚ö°</span>
                    <span>THAO T√ÅC</span>
                  </span>
                </th>
              </tr>
            </thead>
            <tbody>
            {% for f in cleaned_items %}
              {% if f.name|slice:"-4:" == ".csv" or f.name|slice:"-5:" == ".xlsx" %}
              <tr>
                <td><div class="file-name cleaned">{{ f.name }}</div></td>
                <td class="source-cell">
                  <span class="source-badge source-cleaned">ƒê√É L√ÄM S·∫†CH</span>
                </td>
                <td class="time-cell">{{ f.mtime }}</td>
                <td class="size-cell">{{ f.size_mb }} MB</td>
                <td>
                  <div class="op-actions">
                    <a class="pill small" href="{% url 'weather:dataset_view' f.folder|default:'cleaned' f.name %}">üëÄ XEM</a>
                    <a class="pill small primary" href="{% url 'weather:dataset_download' f.folder|default:'cleaned' f.name %}">‚¨áÔ∏è T·∫¢I</a>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">üßπ</div>
            <div>CH∆ØA C√ì D·ªÆ LI·ªÜU ƒê√É L√ÄM S·∫†CH. NH·∫§N N√öT "üßπ L√ÄM S·∫†CH D·ªÆ LI·ªÜU" ƒê·ªÇ B·∫ÆT ƒê·∫¶U.</div>
          </div>
          {% endif %}
        </div>
        
        <!-- CARD D·ªÆ LI·ªÜU TH√î -->
        <div class="datasets-card">
          <div class="datasets-title">
            <div class="title-block">
              <h1 class="page-title">D·ªÆ LI·ªÜU TH√î (CH∆ØA QUA X·ª¨ L√ç) G·∫¶N ƒê√ÇY</h1>
              <div class="page-sub">Duy·ªát, xem tr∆∞·ªõc v√† t·∫£i xu·ªëng c√°c t·ªáp ƒë√£ thu th·∫≠p g·∫ßn nh·∫•t. D·ªØ li·ªáu th√¥ t·ª´ c√°c ngu·ªìn.</div>
              <div class="title-underline"></div>
            </div>

            <div class="actions">
              <button type="button" class="pill merge" id="btnMerge">üîó G·ªòP D·ªÆ LI·ªÜU</button>
            </div>
          </div>

          {% if latest_output %}
            <div class="latest-bar cleaned muted latest-card">
              <span class="latest-label">üìÖ M·ªöI NH·∫§T:</span>
              <span class="latest-name" title="{{ latest_output.name }}">
                <b>{{ latest_output.name }}</b>
              </span>
              <span class="latest-meta">
                <span class="latest-size">üì¶ {{ latest_output.size_mb }} MB</span>
                <span class="latest-time">üïê {{ latest_output.mtime }}</span>
              </span>
            </div>
          {% else %}
            <div class="latest-bar muted" style="font-weight: 700; color: #4a5568;">üì≠ KH√îNG C√ì T·ªÜP N√ÄO TRONG TH∆Ø M·ª§C OUTPUT/</div>
          {% endif %}

          <div id="mergeStatus" class="merge-status"></div>

          <div class="section-badge output">üìÅ TH∆Ø M·ª§C OUTPUT</div>

          {% if output_items %}
          <table>
            <thead>
              <tr>
                <th style="width:35%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">üìÑ</span>
                    <span>T√äN T·ªÜP</span>
                  </span>
                </th>

                <th style="width:25%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">üïê</span>
                    <span>C·∫¨P NH·∫¨T</span>
                  </span>
                </th>

                <th style="width:20%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">üì¶</span>
                    <span>DUNG L∆Ø·ª¢NG</span>
                  </span>
                </th>

                <th style="width:20%;" class="th-center">
                  <span class="th-inner">
                    <span class="th-ico">‚ö°</span>
                    <span>THAO T√ÅC</span>
                  </span>
                </th>
              </tr>
            </thead>
            <tbody>
            {% for f in output_items %}
              {% if f.name|slice:"-5:" == ".xlsx" or f.name|slice:"-4:" == ".csv" %}
              <tr>
                <td><div class="file-name">{{ f.name }}</div></td>
                <td class="time-cell">{{ f.mtime }}</td>
                <td class="size-cell">{{ f.size_mb }} MB</td>
                <td>
                  <div class="op-actions">
                    <a class="pill small" href="{% url 'weather:dataset_view' 'output' f.name %}" style="background: #48bb78; color: white;">üëÄ XEM</a>
                    <a class="pill small primary" href="{% url 'weather:dataset_download' 'output' f.name %}" style="background: #4299e1; color: white;">‚¨áÔ∏è T·∫¢I</a>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div>KH√îNG C√ì D·ªÆ LI·ªÜU N√ÄO TRONG TH∆Ø M·ª§C OUTPUT.</div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Tab 2: Trung t√¢m x·ª≠ l√Ω d·ªØ li·ªáu -->
    <div id="tab2" class="tab-content">
      <div class="processing-card">
        <div class="processing-header">
          <div>
            <div class="processing-title">‚öôÔ∏è TRUNG T√ÇM X·ª¨ L√ù D·ªÆ LI·ªÜU</div>
            <div class="processing-subtitle">Qu·∫£n l√Ω to√†n b·ªô quy tr√¨nh x·ª≠ l√Ω d·ªØ li·ªáu t·ª´ thu th·∫≠p, g·ªôp, l√†m s·∫°ch ƒë·∫øn ph√¢n t√≠ch. T·∫•t c·∫£ trong m·ªôt giao di·ªán duy nh·∫•t.</div>
          </div>
          <div class="processing-badge">ALL-IN-ONE WORKFLOW</div>
        </div>
        
        <!-- Th·ªëng k√™ nhanh -->
        <div class="quick-stats">
          <div class="stat-card">
            <div class="stat-icon">üìÅ</div>
            <div class="stat-number">{{ output_items|length }}</div>
            <div class="stat-label">FILE TH√î</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üîó</div>
            <div class="stat-number">{{ merged_items|length }}</div>
            <div class="stat-label">FILE ƒê√É G·ªòP</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üßπ</div>
            <div class="stat-number">{{ cleaned_items|length }}</div>
            <div class="stat-label">FILE ƒê√É L√ÄM S·∫†CH</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-number">{{ cleaned_items|length|add:merged_items|length }}</div>
            <div class="stat-label">T·ªîNG FILE X·ª¨ L√ù</div>
          </div>
        </div>
        
        <div class="processing-grid">
          <!-- √î g·ªôp d·ªØ li·ªáu -->
          <div class="processing-box merge-box">
            <div class="box-header">
              <div class="box-icon">üîó</div>
              <div class="box-title">G·ªòP D·ªÆ LI·ªÜU TH√îNG MINH</div>
            </div>
            <div class="box-content">
              T·ª± ƒë·ªông ph√°t hi·ªán v√† g·ªôp t·∫•t c·∫£ file d·ªØ li·ªáu t·ª´ nhi·ªÅu ngu·ªìn. H·ªó tr·ª£ ƒëa d·∫°ng ƒë·ªãnh d·∫°ng (CSV, Excel, JSON) v·ªõi kh·∫£ nƒÉng t·ª± ƒë·ªông nh·∫≠n di·ªán c·∫•u tr√∫c d·ªØ li·ªáu.
            </div>
            <div class="box-steps">
              <div class="step-item">
                <div class="step-number">1</div>
                <div>Qu√©t v√† ph√¢n t√≠ch file trong OUTPUT</div>
              </div>
              <div class="step-item">
                <div class="step-number">2</div>
                <div>T·ª± ƒë·ªông cƒÉn ch·ªânh c·ªôt d·ªØ li·ªáu</div>
              </div>
              <div class="step-item">
                <div class="step-number">3</div>
                <div>G·ªôp v√† l∆∞u v√†o MERGE_DATA</div>
              </div>
            </div>
            <div class="box-actions">
              <button type="button" class="pill merge pulse" id="btnMergeMain">üîó G·ªòP D·ªÆ LI·ªÜU</button>
            </div>
          </div>
          
          <!-- √î l√†m s·∫°ch d·ªØ li·ªáu -->
          <div class="processing-box clean-box">
            <div class="box-header">
              <div class="box-icon">üßπ</div>
              <div class="box-title">L√ÄM S·∫†CH N√ÇNG CAO</div>
            </div>
            <div class="box-content">
              √Åp d·ª•ng 7 k·ªπ thu·∫≠t l√†m s·∫°ch chuy√™n s√¢u: x·ª≠ l√Ω missing values, outliers, chu·∫©n h√≥a, m√£ h√≥a, x·ª≠ l√Ω th·ªùi gian, lo·∫°i b·ªè tr√πng l·∫∑p v√† s·ª≠a l·ªói ƒë·ªãnh d·∫°ng.
            </div>
            <div class="box-steps">
              <div class="step-item">
                <div class="step-number">1</div>
                <div>Ch·ªçn ngu·ªìn d·ªØ li·ªáu c·∫ßn l√†m s·∫°ch</div>
              </div>
              <div class="step-item">
                <div class="step-number">2</div>
                <div>T√πy ch·ªçn k·ªπ thu·∫≠t l√†m s·∫°ch</div>
              </div>
              <div class="step-item">
                <div class="step-number">3</div>
                <div>Xu·∫•t b√°o c√°o chi ti·∫øt</div>
              </div>
            </div>
            <div class="box-actions">
              <button type="button" class="pill primary" id="btnCleanMain">üßπ B·∫ÆT ƒê·∫¶U L√ÄM S·∫†CH</button>
            </div>
          </div>
          
          <!-- √î m√¥ t·∫£ quy tr√¨nh -->
          <div class="processing-box desc-box">
            <div class="box-header">
              <div class="box-icon">üìñ</div>
              <div class="box-title">T√ÄI LI·ªÜU & H∆Ø·ªöNG D·∫™N</div>
            </div>
            <div class="box-content">
              Xem chi ti·∫øt to√†n b·ªô quy tr√¨nh x·ª≠ l√Ω, c√°c k·ªπ thu·∫≠t √°p d·ª•ng, th√¥ng s·ªë k·ªπ thu·∫≠t v√† h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng t·ª´ng t√≠nh nƒÉng c·ªßa h·ªá th·ªëng.
            </div>
            <div class="box-steps">
              <div class="step-item">
                <div class="step-number">1</div>
                <div>Quy tr√¨nh x·ª≠ l√Ω d·ªØ li·ªáu</div>
              </div>
              <div class="step-item">
                <div class="step-number">2</div>
                <div>C√°c k·ªπ thu·∫≠t l√†m s·∫°ch</div>
              </div>
              <div class="step-item">
                <div class="step-number">3</div>
                <div>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</div>
              </div>
            </div>
            <div class="box-actions">
              <button type="button" class="pill" id="btnShowDesc">üìñ XEM T√ÄI LI·ªÜU</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL M√î T·∫¢ CHI TI·∫æT QUY TR√åNH -->
  <div id="descModal" class="desc-modal" style="display:none;">
    <div class="desc-modal-content">
      <div class="desc-modal-header">
        <div class="desc-modal-title">üìñ T√ÄI LI·ªÜU H∆Ø·ªöNG D·∫™N X·ª¨ L√ù D·ªÆ LI·ªÜU</div>
        <button class="desc-modal-close" id="descModalClose">‚úï</button>
      </div>
      <div class="desc-modal-body">
        <div class="desc-section">
          <div class="section-title">üéØ T·ªîNG QUAN H·ªÜ TH·ªêNG</div>
          <div class="section-content">
            H·ªá th·ªëng x·ª≠ l√Ω d·ªØ li·ªáu ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ qu·∫£n l√Ω to√†n b·ªô v√≤ng ƒë·ªùi d·ªØ li·ªáu t·ª´ thu th·∫≠p ƒë·∫øn ph√¢n t√≠ch.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL L√ÄM S·∫†CH D·ªÆ LI·ªÜU (WIZARD) -->
  <div class="cw-overlay" id="cwOverlay" style="display:none;">
    <div class="cw-modal">
      <div class="cw-top">
        <div>
          <div class="cw-title">üßº WIZARD L√ÄM S·∫†CH D·ªÆ LI·ªÜU</div>
          <div class="cw-sub">Ch·ªçn ngu·ªìn ‚Üí ch·ªçn file ‚Üí ch·ªçn k·ªπ thu·∫≠t ‚Üí xem ti·∫øn tr√¨nh ‚Üí t·∫£i k·∫øt qu·∫£</div>
        </div>
        <button class="pill" id="cwClose">‚úï</button>
      </div>

      <div class="cw-step" id="cwStep1">
        <div class="cw-grid2">
          <button class="cw-choice" data-source="merge">
            <div class="cw-choice__t">üß© FILE ƒê√É G·ªòP</div>
            <div class="cw-choice__d">ƒê·ªçc t·ª´ Merge_data ‚Üí l∆∞u v√†o Clean_Data_For_File_Merge</div>
          </button>

          <button class="cw-choice" data-source="output">
            <div class="cw-choice__t">üì¶ FILE CH∆ØA G·ªòP</div>
            <div class="cw-choice__d">ƒê·ªçc t·ª´ output ‚Üí l∆∞u v√†o Clean_Data_For_File_Not_Merge</div>
          </button>
        </div>
      </div>

      <div class="cw-step" id="cwStep2" style="display:none;">
        <div class="cw-row">
          <div class="cw-pill" id="cwSourceLabel">Ngu·ªìn: ‚Äî</div>
          <input class="cw-search" id="cwSearch" placeholder="T√¨m file..." />
          <button class="pill" id="cwBack">‚Ü© QUAY L·∫†I</button>
        </div>

        <div class="cw-technique-selector" style="margin: 15px 0; padding: 15px; background: #f8fafc; border-radius: 8px;">
          <div style="font-weight: 600; margin-bottom: 8px; color: #2d3748;">üéØ CH·ªåN K·ª∏ THU·∫¨T L√ÄM S·∫†CH:</div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <select id="cwTechnique" class="technique-select" style="flex: 1; min-width: 250px; padding: 10px 14px; border: 2px solid #4299e1; border-radius: 6px; background: white; font-size: 14px; color: #2d3748;">
              <option value="all">‚úÖ T·∫§T C·∫¢ K·ª∏ THU·∫¨T (M·∫∂C ƒê·ªäNH)</option>
              <option value="missing">üîç X·ª¨ L√ù MISSING VALUES</option>
              <option value="duplicates">üßπ X√ìA D·ªÆ LI·ªÜU TR√ôNG L·∫∂P</option>
              <option value="outliers">üìä X·ª¨ L√ù OUTLIERS</option>
              <option value="normalize">üìê CHU·∫®N H√ìA D·ªÆ LI·ªÜU</option>
              <option value="encode">üî§ M√É H√ìA D·ªÆ LI·ªÜU PH√ÇN LO·∫†I</option>
              <option value="datetime">‚è∞ X·ª¨ L√ù D·ªÆ LI·ªÜU TH·ªúI GIAN</option>
            </select>
            <div class="technique-info" style="flex: 2; padding: 10px; background: #ebf8ff; border-radius: 6px; border-left: 4px solid #4299e1;">
              <div id="techniqueDescription" style="font-size: 13px; color: #4a5568;">
                <strong>‚úÖ T·∫•t c·∫£ k·ªπ thu·∫≠t:</strong> √Åp d·ª•ng t·∫•t c·∫£ c√°c k·ªπ thu·∫≠t l√†m s·∫°ch bao g·ªìm x·ª≠ l√Ω missing values, duplicates, outliers, chu·∫©n h√≥a, m√£ h√≥a v√† th·ªùi gian.
              </div>
            </div>
          </div>
          <div style="margin-top: 10px; font-size: 12px; color: #718096; display: flex; align-items: center; gap: 5px;">
            <span>üí°</span>
            <span>Ch·ªçn k·ªπ thu·∫≠t ph√π h·ª£p v·ªõi nhu c·∫ßu ph√¢n t√≠ch d·ªØ li·ªáu c·ªßa b·∫°n</span>
          </div>
        </div>

        <div class="cw-filelist" id="cwFileList"></div>

        <div class="cw-actions">
          <button class="pill" id="cwStart" disabled style="background:linear-gradient(135deg,#48bb78,#38a169);color:#fff;">üöÄ B·∫ÆT ƒê·∫¶U L√ÄM S·∫†CH</button>
        </div>
      </div>

      <div class="cw-step" id="cwStep3" style="display:none;">
        <div class="cw-progress">
          <div class="cw-bar"><div class="cw-bar__fill" id="cwBarFill" style="width:0%;"></div></div>
          <div class="cw-prow">
            <div class="cw-steptext" id="cwStepText">ƒêang kh·ªüi t·∫°o‚Ä¶</div>
            <div class="cw-pct" id="cwPct">0%</div>
          </div>
        </div>

        <div class="cw-log" id="cwLog"></div>
        
        <div class="cw-technique-info" style="margin: 15px 0; padding: 15px; background: #f0fff4; border-radius: 8px; border-left: 4px solid #48bb78;">
          <div style="font-weight: 600; margin-bottom: 5px; color: #276749;">üéØ K·ª∏ THU·∫¨T ƒê√É CH·ªåN:</div>
          <div id="selectedTechniqueDisplay" style="font-weight: 500; color: #2d3748;">‚Äî</div>
        </div>
        
        <div class="cw-report" id="cwReport" style="display:none;"></div>

        <div class="cw-actions">
          <a class="pill" id="cwViewBtn" href="#" style="display:none;background:#48bb78;color:#fff;">üëÄ XEM NGAY</a>
          <a class="pill primary" id="cwDownloadBtn" href="#" style="display:none;background:#4299e1;color:#fff;">‚¨áÔ∏è T·∫¢I V·ªÄ</a>
          <button class="pill" id="cwDone" style="display:none;">‚úÖ ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL K·∫æT QU·∫¢ G·ªòP D·ªÆ LI·ªÜU -->
  <div id="mergeResultModal" class="wf-modal" aria-hidden="true">
    <div class="wf-modal__backdrop" data-close="1"></div>

    <div class="wf-modal__panel" role="dialog" aria-modal="true" aria-labelledby="mergeModalTitle">
      <button class="wf-modal__close" type="button" data-close="1">‚úï</button>

      <h3 id="mergeModalTitle">‚úÖ G·ªòP D·ªÆ LI·ªÜU HO√ÄN T·∫§T</h3>
      <p id="mergeModalMsg" class="wf-modal__msg"></p>

      <div class="wf-modal__file">
        <div class="wf-kv"><span>üìÑ T·ªáp:</span> <b id="mergeFileName">‚Äî</b></div>
        <div class="wf-kv"><span>üì¶ Dung l∆∞·ª£ng:</span> <b id="mergeFileSize">‚Äî</b></div>
        <div class="wf-kv"><span>üïê C·∫≠p nh·∫≠t:</span> <b id="mergeFileTime">‚Äî</b></div>
      </div>

      <div class="wf-modal__actions">
        <a id="mergeViewBtn" class="pill" href="#">üëÄ XEM</a>
        <a id="mergeDownloadBtn" class="pill primary" href="#">‚¨áÔ∏è T·∫¢I</a>
        <button class="pill" type="button" data-close="1">‚úñ ƒê√ìNG</button>
      </div>
    </div>
  </div>

  <script>
    // M√¥ t·∫£ k·ªπ thu·∫≠t l√†m s·∫°ch
    const TECHNIQUE_DESCRIPTIONS = {
      "all": "‚úÖ <strong>T·∫•t c·∫£ k·ªπ thu·∫≠t:</strong> √Åp d·ª•ng t·∫•t c·∫£ c√°c k·ªπ thu·∫≠t l√†m s·∫°ch bao g·ªìm x·ª≠ l√Ω missing values, duplicates, outliers, chu·∫©n h√≥a, m√£ h√≥a v√† th·ªùi gian.",
      "missing": "üîç <strong>X·ª≠ l√Ω Missing Values:</strong> Ph√°t hi·ªán v√† x·ª≠ l√Ω c√°c gi√° tr·ªã thi·∫øu b·∫±ng c√°ch ƒëi·ªÅn gi√° tr·ªã trung b√¨nh/trung v·ªã ho·∫∑c x√≥a d√≤ng.",
      "duplicates": "üßπ <strong>X√≥a d·ªØ li·ªáu tr√πng l·∫∑p:</strong> T√¨m v√† lo·∫°i b·ªè c√°c b·∫£n ghi tr√πng l·∫∑p ho√†n to√†n trong dataset.",
      "outliers": "üìä <strong>X·ª≠ l√Ω Outliers:</strong> Ph√°t hi·ªán v√† x·ª≠ l√Ω c√°c gi√° tr·ªã ngo·∫°i lai b·∫±ng ph∆∞∆°ng ph√°p IQR ho·∫∑c Z-score.",
      "normalize": "üìê <strong>Chu·∫©n h√≥a d·ªØ li·ªáu:</strong> Chu·∫©n h√≥a c√°c c·ªôt s·ªë v·ªÅ c√πng m·ªôt t·ª∑ l·ªá (Min-Max ho·∫∑c Z-score).",
      "encode": "üî§ <strong>M√£ h√≥a d·ªØ li·ªáu ph√¢n lo·∫°i:</strong> Chuy·ªÉn ƒë·ªïi c√°c bi·∫øn ph√¢n lo·∫°i th√†nh d·∫°ng s·ªë (One-Hot ho·∫∑c Label Encoding).",
      "datetime": "‚è∞ <strong>X·ª≠ l√Ω d·ªØ li·ªáu th·ªùi gian:</strong> T√°ch ng√†y/th√°ng/nƒÉm/gi·ªù t·ª´ c·ªôt th·ªùi gian v√† t·∫°o c√°c ƒë·∫∑c tr∆∞ng m·ªõi."
    };

    document.addEventListener("DOMContentLoaded", function () {
      // ========== X·ª¨ L√ù TABS ==========
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tabId = button.getAttribute('data-tab');
          
          // X√≥a active class t·ª´ t·∫•t c·∫£ buttons v√† contents
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Th√™m active class cho button v√† content ƒë∆∞·ª£c ch·ªçn
          button.classList.add('active');
          document.getElementById(tabId).classList.add('active');
        });
      });
      
      // ========== X·ª¨ L√ù C√ÅC N√öT TRONG TRUNG T√ÇM X·ª¨ L√ù (TAB 2) ==========
      const btnMergeMain = document.getElementById("btnMergeMain");
      const btnCleanMain = document.getElementById("btnCleanMain");
      const btnShowDesc = document.getElementById("btnShowDesc");
      const descModal = document.getElementById("descModal");
      const descModalClose = document.getElementById("descModalClose");
      
      // N√∫t g·ªôp d·ªØ li·ªáu ch√≠nh
      if (btnMergeMain) {
        btnMergeMain.addEventListener("click", function() {
          // Chuy·ªÉn sang tab 1
          document.querySelector('[data-tab="tab1"]').click();
          // K√≠ch ho·∫°t n√∫t g·ªôp d·ªØ li·ªáu trong tab 1
          setTimeout(() => {
            const btnMerge = document.getElementById("btnMerge");
            if (btnMerge) {
              btnMerge.click();
            }
          }, 300);
        });
      }
      
      // N√∫t l√†m s·∫°ch d·ªØ li·ªáu ch√≠nh
      if (btnCleanMain) {
        btnCleanMain.addEventListener("click", function() {
          // Chuy·ªÉn sang tab 1
          document.querySelector('[data-tab="tab1"]').click();
          // K√≠ch ho·∫°t n√∫t l√†m s·∫°ch d·ªØ li·ªáu trong tab 1
          setTimeout(() => {
            const btnClean = document.getElementById("btnClean");
            if (btnClean) {
              btnClean.click();
            }
          }, 300);
        });
      }
      
      // N√∫t hi·ªÉn th·ªã modal m√¥ t·∫£
      if (btnShowDesc && descModal) {
        btnShowDesc.addEventListener("click", function() {
          descModal.style.display = "flex";
          document.body.style.overflow = 'hidden';
        });
        
        if (descModalClose) {
          descModalClose.addEventListener("click", function() {
            descModal.style.display = "none";
            document.body.style.overflow = 'auto';
          });
        }
        
        // ƒê√≥ng modal khi click b√™n ngo√†i
        descModal.addEventListener("click", function(e) {
          if (e.target === descModal) {
            descModal.style.display = "none";
            document.body.style.overflow = 'auto';
          }
        });
        
        // ƒê√≥ng modal b·∫±ng ph√≠m ESC
        document.addEventListener("keydown", function(e) {
          if (e.key === "Escape" && descModal.style.display === "flex") {
            descModal.style.display = "none";
            document.body.style.overflow = 'auto';
          }
        });
      }
      
      // ========== X·ª¨ L√ù N√öT QUAY L·∫†I ==========
      const btnBack = document.getElementById("btnBack");
      if (btnBack) {
        btnBack.addEventListener("click", function () {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = "{% url 'weather:home' %}";
          }
        });
      }
      
      // ========== X·ª¨ L√ù G·ªòP D·ªÆ LI·ªÜU ==========
      const btnMerge = document.getElementById("btnMerge");
      const mergeStatusEl = document.getElementById("mergeStatus");
      
      if (btnMerge) {
        btnMerge.addEventListener("click", async function () {
          btnMerge.disabled = true;
          btnMerge.innerHTML = "‚è≥ ƒêANG G·ªòP...";
          btnMerge.style.background = "linear-gradient(135deg, #718096, #4a5568)";
          
          // C·∫≠p nh·∫≠t n√∫t g·ªôp ch√≠nh n·∫øu c√≥
          if (btnMergeMain) {
            btnMergeMain.disabled = true;
            btnMergeMain.innerHTML = "‚è≥ ƒêANG G·ªòP...";
            btnMergeMain.style.background = "linear-gradient(135deg, #718096, #4a5568)";
          }

          showStatus("ƒêANG X·ª¨ L√ù G·ªòP D·ªÆ LI·ªÜU... VUI L√íNG CH·ªú", "processing", mergeStatusEl);

          try {
            const res = await fetch("{% url 'weather:merge_data' %}", {
              method: "POST",
              headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest"
              }
            });

            const data = await res.json();

            if (data.success) {
              showStatus(data.message || "‚úÖ G·ªòP D·ªÆ LI·ªÜU TH√ÄNH C√îNG!", "success", mergeStatusEl);

              if (data.latest_merged) {
                openMergeModal(data.latest_merged, data.message);
              } else {
                setTimeout(() => window.location.reload(), 1200);
              }

            } else {
              showStatus("‚ùå " + (data.message || "C√ì L·ªñI X·∫¢Y RA KHI G·ªòP D·ªÆ LI·ªÜU"), "error", mergeStatusEl);

              if (data.latest_merged) {
                openMergeModal(data.latest_merged, data.message);
              }

              // Reset n√∫t
              resetMergeButtons();
            }

          } catch (err) {
            showStatus("‚ùå L·ªñI K·∫æT N·ªêI: " + err.message, "error", mergeStatusEl);
            resetMergeButtons();
          }
        });
      }
      
      function resetMergeButtons() {
        if (btnMerge) {
          btnMerge.disabled = false;
          btnMerge.innerHTML = "üîó G·ªòP D·ªÆ LI·ªÜU";
          btnMerge.style.background = "linear-gradient(135deg, #9f7aea, #805ad5)";
        }
        if (btnMergeMain) {
          btnMergeMain.disabled = false;
          btnMergeMain.innerHTML = "üîó G·ªòP D·ªÆ LI·ªÜU";
          btnMergeMain.style.background = "linear-gradient(135deg, #9f7aea, #805ad5)";
        }
      }
      
      // ========== MODAL K·∫æT QU·∫¢ G·ªòP D·ªÆ LI·ªÜU ==========
      function openMergeModal(file, msg){
        const modal = document.getElementById('mergeResultModal');
        if (!modal) return;

        document.getElementById('mergeModalMsg').textContent = msg || 'G·ªôp d·ªØ li·ªáu th√†nh c√¥ng!';
        document.getElementById('mergeFileName').textContent = (file && file.name) ? file.name : '‚Äî';
        document.getElementById('mergeFileSize').textContent = (file && file.size_mb != null) ? (file.size_mb + ' MB') : '‚Äî';
        document.getElementById('mergeFileTime').textContent = (file && file.mtime) ? file.mtime : '‚Äî';

        const viewBtn = document.getElementById('mergeViewBtn');
        const dlBtn = document.getElementById('mergeDownloadBtn');
        viewBtn.href = (file && file.view_url) ? file.view_url : '#';
        dlBtn.href = (file && file.download_url) ? file.download_url : '#';

        modal.classList.add('wf-modal--open');
        modal.setAttribute('aria-hidden', 'false');
      }

      function closeMergeModal(){
        const modal = document.getElementById('mergeResultModal');
        if (!modal) return;
        modal.classList.remove('wf-modal--open');
        modal.setAttribute('aria-hidden', 'true');
        window.location.reload();
      }

      document.addEventListener('click', (e) => {
        if (e.target && e.target.closest('#mergeResultModal [data-close]')) {
          closeMergeModal();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeMergeModal();
      });
      
      // ========== WIZARD L√ÄM S·∫†CH D·ªÆ LI·ªÜU ==========
      const CLEAN_LIST_URL = "{% url 'weather:clean_list' %}";
      const CLEAN_START_URL = "{% url 'weather:clean_data' %}";
      const CLEAN_TAIL_URL = "{% url 'weather:clean_tail' %}";

      const cwOverlay = document.getElementById("cwOverlay");
      const cwClose = document.getElementById("cwClose");
      const cwStep1 = document.getElementById("cwStep1");
      const cwStep2 = document.getElementById("cwStep2");
      const cwStep3 = document.getElementById("cwStep3");

      const cwSourceLabel = document.getElementById("cwSourceLabel");
      const cwSearch = document.getElementById("cwSearch");
      const cwBack = document.getElementById("cwBack");
      const cwFileList = document.getElementById("cwFileList");
      const cwStart = document.getElementById("cwStart");

      const cwBarFill = document.getElementById("cwBarFill");
      const cwStepText = document.getElementById("cwStepText");
      const cwPct = document.getElementById("cwPct");
      const cwLog = document.getElementById("cwLog");
      const cwReport = document.getElementById("cwReport");
      const cwViewBtn = document.getElementById("cwViewBtn");
      const cwDownloadBtn = document.getElementById("cwDownloadBtn");
      const cwDone = document.getElementById("cwDone");
      const selectedTechniqueDisplay = document.getElementById("selectedTechniqueDisplay");
      const cwTechnique = document.getElementById("cwTechnique");
      const techniqueDescription = document.getElementById("techniqueDescription");

      let cwSource = null;
      let cwFiles = [];
      let cwSelected = null;
      let cwJobId = null;
      let cwSince = 0;
      let cwTimer = null;
      
      // C·∫≠p nh·∫≠t m√¥ t·∫£ k·ªπ thu·∫≠t
      if (cwTechnique && techniqueDescription) {
        cwTechnique.addEventListener("change", function() {
          const selectedValue = this.value;
          techniqueDescription.innerHTML = TECHNIQUE_DESCRIPTIONS[selectedValue] || TECHNIQUE_DESCRIPTIONS["all"];
        });
      }

      function cwShowStep(n){
        cwStep1.style.display = (n===1) ? "" : "none";
        cwStep2.style.display = (n===2) ? "" : "none";
        cwStep3.style.display = (n===3) ? "" : "none";
      }

      function cwOpen(){
        cwOverlay.style.display = "";
        cwShowStep(1);
        cwSource = null;
        cwFiles = [];
        cwSelected = null;
        cwFileList.innerHTML = "";
        cwStart.disabled = true;
        cwLog.textContent = "";
        cwReport.style.display = "none";
        cwViewBtn.style.display = "none";
        cwDownloadBtn.style.display = "none";
        cwDone.style.display = "none";
        if (cwTimer) clearInterval(cwTimer);
        cwTimer = null;
      }

      function cwCloseModal(){
        cwOverlay.style.display = "none";
        if (cwTimer) clearInterval(cwTimer);
        cwTimer = null;
      }

      // N√∫t l√†m s·∫°ch
      const btnClean = document.getElementById("btnClean");
      if (btnClean) btnClean.addEventListener("click", cwOpen);
      
      // C√°c s·ª± ki·ªán ƒë√≥ng modal
      if (cwClose) cwClose.addEventListener("click", cwCloseModal);
      if (cwOverlay) cwOverlay.addEventListener("click", (e) => { if (e.target === cwOverlay) cwCloseModal(); });

      function cwRender(list){
        cwFileList.innerHTML = "";
        if (!list.length){
          cwFileList.innerHTML = `<div class="cw-empty">üì≠ Kh√¥ng c√≥ file trong th∆∞ m·ª•c n√†y.</div>`;
          return;
        }
        list.forEach((f) => {
          const row = document.createElement("label");
          row.className = "cw-file";
          row.innerHTML = `
            <input type="radio" name="cwFile" value="${f.name}">
            <div class="cw-file__main">
              <div class="cw-file__name">${f.name}</div>
              <div class="cw-file__meta">üì¶ ${f.size_mb} MB ‚Ä¢ üïê ${f.mtime}</div>
            </div>
            <div class="cw-file__ext">${(f.ext || "").replace(".","").toUpperCase()}</div>
          `;
          row.querySelector("input").addEventListener("change", () => {
            cwSelected = f.name;
            cwStart.disabled = false;
          });
          cwFileList.appendChild(row);
        });
      }

      async function cwLoadList(source){
        cwSource = source;
        cwSelected = null;
        cwStart.disabled = true;

        cwSourceLabel.textContent = "Ngu·ªìn: " + (source === "merge" ? "Merge_data (ƒë√£ g·ªôp)" : "output (ch∆∞a g·ªôp)");
        cwShowStep(2);
        cwFileList.innerHTML = `<div class="cw-empty">‚è≥ ƒêang t·∫£i danh s√°ch file‚Ä¶</div>`;

        const res = await fetch(`${CLEAN_LIST_URL}?source=${encodeURIComponent(source)}`);
        const data = await res.json();
        if (!data.ok){
          cwFileList.innerHTML = `<div class="cw-empty">‚ùå ${data.message || "L·ªói t·∫£i danh s√°ch"}</div>`;
          return;
        }
        cwFiles = data.files || [];
        cwRender(cwFiles);
      }

      if (cwStep1) {
        cwStep1.querySelectorAll(".cw-choice").forEach(btn => {
          btn.addEventListener("click", () => cwLoadList(btn.dataset.source));
        });
      }

      if (cwBack) cwBack.addEventListener("click", () => cwShowStep(1));

      if (cwSearch) {
        cwSearch.addEventListener("input", () => {
          const q = (cwSearch.value || "").toLowerCase().trim();
          const filtered = cwFiles.filter(x => x.name.toLowerCase().includes(q));
          cwRender(filtered);
        });
      }

      if (cwStart) {
        cwStart.addEventListener("click", async () => {
          if (!cwSource || !cwSelected) return;

          const technique = document.getElementById("cwTechnique").value;
          const techniqueText = document.getElementById("cwTechnique").options[document.getElementById("cwTechnique").selectedIndex].text;
          
          // Hi·ªÉn th·ªã k·ªπ thu·∫≠t ƒë√£ ch·ªçn
          selectedTechniqueDisplay.textContent = techniqueText;

          cwShowStep(3);
          cwBarFill.style.width = "0%";
          cwStepText.textContent = "ƒêang kh·ªüi t·∫°o‚Ä¶";
          cwPct.textContent = "0%";
          cwLog.textContent = "";
          cwReport.style.display = "none";
          cwViewBtn.style.display = "none";
          cwDownloadBtn.style.display = "none";
          cwDone.style.display = "none";

          const res = await fetch(CLEAN_START_URL, {
            method: "POST",
            headers: {
              "X-CSRFToken": getCookie("csrftoken"),
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ 
              source: cwSource, 
              filename: cwSelected,
              technique: technique
            })
          });

          const data = await res.json();
          if (!data.ok){
            cwLog.textContent = "‚ùå " + (data.message || "Kh√¥ng start ƒë∆∞·ª£c job");
            cwDone.style.display = "";
            return;
          }

          cwJobId = data.job_id;
          cwSince = 0;

          cwTimer = setInterval(async () => {
            const r = await fetch(`${CLEAN_TAIL_URL}?job_id=${encodeURIComponent(cwJobId)}&since=${cwSince}`);
            const t = await r.json();
            if (!t.ok) return;

            const p = t.progress || {pct:0, step:""};
            cwBarFill.style.width = (p.pct || 0) + "%";
            cwPct.textContent = (p.pct || 0) + "%";
            cwStepText.textContent = p.step || "ƒêang ch·∫°y‚Ä¶";

            const lines = t.lines || [];
            if (lines.length){
              cwLog.textContent += (cwLog.textContent ? "\n" : "") + lines.join("\n");
              cwLog.scrollTop = cwLog.scrollHeight;
              cwSince = t.next_since || cwSince;
            }

            if (t.done){
              clearInterval(cwTimer);
              cwTimer = null;

              if (t.error){
                cwLog.textContent += "\n\n‚ùå " + t.error;
                cwDone.style.display = "";
                return;
              }

              const rsl = t.result || {};
              const rep = rsl.report || {};

              cwReport.style.display = "";
              cwReport.innerHTML = `
                <div class="cw-rgrid">
                  <div class="cw-ritem"><div class="cw-rl">Input</div><div class="cw-rv">${rsl.input_file || "-"}</div></div>
                  <div class="cw-ritem"><div class="cw-rl">Output</div><div class="cw-rv">${rsl.output_file || "-"}</div></div>
                  <div class="cw-ritem"><div class="cw-rl">K·ªπ thu·∫≠t</div><div class="cw-rv">${techniqueText}</div></div>
                  <div class="cw-ritem"><div class="cw-rl">Rows</div><div class="cw-rv">${rep.rows_before || 0} ‚Üí ${rep.rows_after || 0}</div></div>
                  <div class="cw-ritem"><div class="cw-rl">Missing</div><div class="cw-rv">${rep.missing_before || 0} ‚Üí ${rep.missing_after || 0}</div></div>
                  <div class="cw-ritem"><div class="cw-rl">Dup removed</div><div class="cw-rv">${rep.duplicates_removed || 0}</div></div>
                  <div class="cw-ritem"><div class="cw-rl">Size</div><div class="cw-rv">${rsl.size_mb || "-"} MB</div></div>
                </div>
              `;

              if (rsl.view_url){
                cwViewBtn.href = rsl.view_url;
                cwViewBtn.style.display = "";
              }
              if (rsl.download_url){
                cwDownloadBtn.href = rsl.download_url;
                cwDownloadBtn.style.display = "";
              }
              cwDone.style.display = "";
            }
          }, 800);
        });
      }

      if (cwDone) cwDone.addEventListener("click", () => {
        cwCloseModal();
        window.location.reload();
      });
      
      // ========== HI·ªÜU ·ª®NG HOVER CHO C√ÅC BOX ==========
      const processingBoxes = document.querySelectorAll(".processing-box");
      processingBoxes.forEach(box => {
        box.addEventListener("mouseenter", function() {
          this.style.transform = "translateY(-8px)";
          this.style.boxShadow = "0 25px 50px rgba(0, 0, 0, 0.15)";
        });
        
        box.addEventListener("mouseleave", function() {
          this.style.transform = "translateY(0)";
          this.style.boxShadow = "0 8px 30px rgba(0, 0, 0, 0.08)";
        });
      });
      
      // Hi·ªáu ·ª©ng hover cho stat cards
      const statCards = document.querySelectorAll(".stat-card");
      statCards.forEach(card => {
        card.addEventListener("mouseenter", function() {
          this.style.transform = "translateY(-5px)";
        });
        
        card.addEventListener("mouseleave", function() {
          this.style.transform = "translateY(0)";
        });
      });
      
      // ========== C√ÅC H√ÄM H·ªñ TR·ª¢ ==========
      function showStatus(message, type, element) {
        if (!element) return;
        
        element.textContent = message;
        element.className = "merge-status show " + type;
        
        if (type !== "processing") {
          setTimeout(() => {
            element.classList.remove("show");
          }, 5000);
        }
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    });
  </script>

  <div class="wx-layer wx-clouds" aria-hidden="true"></div>
  <div class="wx-layer wind-layer" aria-hidden="true"></div>
  <div class="wx-layer wx-rain" aria-hidden="true"></div>
  <div class="wx-layer wx-lightning" aria-hidden="true"></div>
  <div class="wx-layer wx-lightning" aria-hidden="true"></div>
</body>
</html>