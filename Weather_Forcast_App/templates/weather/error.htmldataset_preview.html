<!-- templates/weather/dataset_preview.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xem: {{ filename }}</title>
    <style>
        /* CSS cho trang xem file */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0a192f 0%, #1a365d 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        .container {
            background: rgba(22, 32, 45, 0.9);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.3);
            max-width: 95%;
            margin: 0 auto;
        }
        h1 {
            color: #38b2ac;
            border-bottom: 2px solid #38b2ac;
            padding-bottom: 15px;
            margin-top: 0;
        }
        .file-info {
            background: rgba(30, 41, 59, 0.7);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #38b2ac;
        }
        .stats {
            color: #a0aec0;
            margin: 15px 0;
            font-style: italic;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #38b2ac;
        }
        .load-more {
            text-align: center;
            margin: 30px 0;
        }
        .btn {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: linear-gradient(135deg, #3182ce, #2c5282);
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .back-btn {
            display: inline-block;
            margin: 10px 10px 10px 0;
            padding: 10px 25px;
            background: rgba(113, 128, 150, 0.3);
            color: #cbd5e0;
            text-decoration: none;
            border-radius: 25px;
            border: 1px solid rgba(113, 128, 150, 0.5);
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            background: rgba(113, 128, 150, 0.5);
            transform: translateY(-2px);
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 25px 0;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            overflow: hidden;
        }
        thead {
            background: linear-gradient(135deg, rgba(26, 54, 93, 0.9), rgba(30, 64, 175, 0.8));
        }
        th {
            padding: 18px;
            text-align: left;
            font-weight: 700;
            color: #e2e8f0;
            border-bottom: 2px solid #38b2ac;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid rgba(56, 178, 172, 0.1);
            color: #cbd5e0;
        }
        tr:hover {
            background: rgba(56, 178, 172, 0.1);
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 25px 0;
        }
        .page-btn {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(56, 178, 172, 0.2);
            color: #38b2ac;
            border: 1px solid rgba(56, 178, 172, 0.3);
            cursor: pointer;
        }
        .page-btn.active {
            background: linear-gradient(135deg, #38b2ac, #4299e1);
            color: white;
        }
        .table-container {
            max-height: 70vh;
            overflow: auto;
            border-radius: 12px;
        }
        .text-container {
            max-height: 70vh;
            overflow: auto;
            background: rgba(30, 41, 59, 0.5);
            padding: 25px;
            border-radius: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            line-height: 1.6;
            font-size: 14px;
        }
        .text-container pre {
            margin: 0;
            font-family: inherit;
            color: #cbd5e0;
        }
        .text-container .json-key {
            color: #38b2ac;
            font-weight: 600;
        }
        .text-container .json-string {
            color: #fbb6ce;
        }
        .text-container .json-number {
            color: #68d391;
        }
        .text-container .json-boolean {
            color: #4299e1;
        }
        .text-container .json-null {
            color: #718096;
        }
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(22, 32, 45, 0.5);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(56, 178, 172, 0.5);
            border-radius: 5px;
        }
        
        /* Styling cho file JSON */
        .json-view {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            line-height: 1.5;
        }
        
        /* File header */
        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(56, 178, 172, 0.2);
        }
        
        /* File type indicator */
        .file-type {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 10px;
            text-transform: uppercase;
        }
        .type-csv { background: rgba(72, 187, 120, 0.2); color: #68d391; }
        .type-excel { background: rgba(56, 178, 172, 0.2); color: #38b2ac; }
        .type-txt { background: rgba(113, 128, 150, 0.2); color: #a0aec0; }
        .type-json { background: rgba(159, 122, 234, 0.2); color: #d6bcfa; }
        
        /* Action buttons container */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
    
    {% if file_type == 'json' %}
    <script>
        // Function to syntax highlight JSON
        function syntaxHighlight(json) {
            if (typeof json != 'string') {
                json = JSON.stringify(json, null, 2);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        // Apply syntax highlighting when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const jsonContent = document.getElementById('jsonContent');
            if (jsonContent) {
                try {
                    const jsonObj = JSON.parse(jsonContent.textContent);
                    jsonContent.innerHTML = syntaxHighlight(jsonObj);
                } catch (e) {
                    // If not valid JSON, keep as plain text
                    console.log('Not a valid JSON file');
                }
            }
        });
    </script>
    {% endif %}
</head>
<body>
    <div class="container">
        <div class="file-header">
            <div>
                <h1 style="margin: 0; display: flex; align-items: center;">
                    üìÑ {{ filename }}
                    <span class="file-type type-{{ file_type }}">{{ file_type|upper }}</span>
                </h1>
            </div>
            <div>
                <a href="{{ referer_url }}" class="back-btn">üìã Quay l·∫°i</a>
            </div>
        </div>
        
        <div class="file-info">
            <strong>üìÅ Th∆∞ m·ª•c:</strong> {{ folder }}<br>
            <strong>üìè K√≠ch th∆∞·ªõc:</strong> {{ file_size_kb|floatformat:2 }} KB<br>
            {% if is_table %}
                <strong>üìä T·ªïng s·ªë d√≤ng:</strong> <span id="totalRows">{{ total_rows }}</span><br>
                <strong>üëÅÔ∏è ƒêang hi·ªÉn th·ªã:</strong> <span id="showingRows">{{ showing_rows }}</span> d√≤ng ƒë·∫ßu
            {% endif %}
        </div>
        
        {% if is_table %}
            <!-- Hi·ªÉn th·ªã b·∫£ng cho CSV/Excel -->
            <div class="table-container" id="tableContainer">
                {{ html_table|safe }}
            </div>
            
            <div class="loading" id="loading">
                ‚è≥ ƒêang t·∫£i th√™m d·ªØ li·ªáu...
            </div>
            
            <div class="load-more" id="loadMoreContainer">
                <button class="btn" id="loadMoreBtn" onclick="loadMoreData()">
                    ‚¨áÔ∏è T·∫£i th√™m d·ªØ li·ªáu
                </button>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- Pagination s·∫Ω ƒë∆∞·ª£c t·∫°o b·ªüi JavaScript -->
            </div>
        {% else %}
            <!-- Hi·ªÉn th·ªã n·ªôi dung text cho TXT/JSON -->
            <div class="text-container">
                {% if file_type == 'json' %}
                    <pre id="jsonContent">{{ content }}</pre>
                {% else %}
                    <pre>{{ content }}</pre>
                {% endif %}
            </div>
        {% endif %}
        
        <div class="action-buttons">
            <a href="{{ referer_url }}" class="back-btn">üìã Quay l·∫°i danh s√°ch</a>
            <a href="{{ download_url }}" class="back-btn" style="background: linear-gradient(135deg, #4299e1, #3182ce); color: white;">
                ‚¨áÔ∏è T·∫£i to√†n b·ªô file
            </a>
        </div>
    </div>
    
    {% if is_table %}
    <script>
        // JavaScript cho ph√¢n trang v√† lazy loading (ch·ªâ cho CSV/Excel)
        let currentPage = 1;
        const rowsPerPage = {{ rows_per_page }};
        let totalRows = {{ total_rows }};
        let totalPages = Math.ceil(totalRows / rowsPerPage);
        
        // T·∫°o ph√¢n trang
        function createPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            // N√∫t ƒë·∫ßu
            if (currentPage > 1) {
                const btn = document.createElement('button');
                btn.className = 'page-btn';
                btn.innerHTML = '‚èÆÔ∏è ƒê·∫ßu';
                btn.onclick = () => loadPage(1);
                pagination.appendChild(btn);
            }
            
            // C√°c n√∫t s·ªë trang
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
                btn.innerHTML = i;
                btn.onclick = () => loadPage(i);
                pagination.appendChild(btn);
            }
            
            // N√∫t cu·ªëi
            if (currentPage < totalPages) {
                const btn = document.createElement('button');
                btn.className = 'page-btn';
                btn.innerHTML = '‚è≠Ô∏è Cu·ªëi';
                btn.onclick = () => loadPage(totalPages);
                pagination.appendChild(btn);
            }
        }
        
        // T·∫£i th√™m d·ªØ li·ªáu
        async function loadMoreData() {
            currentPage++;
            await loadPage(currentPage);
        }
        
        // T·∫£i trang c·ª• th·ªÉ
        async function loadPage(page) {
            const loading = document.getElementById('loading');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const tableContainer = document.getElementById('tableContainer');
            
            loading.style.display = 'block';
            loadMoreBtn.disabled = true;
            
            try {
                const response = await fetch(`?page=${page}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const data = await response.json();
                
                if (data.data.length > 0) {
                    // T·∫°o b·∫£ng m·ªõi t·ª´ d·ªØ li·ªáu
                    let tableHtml = '<table class="table table-striped table-bordered"><thead><tr>';
                    
                    // T·∫°o header t·ª´ keys c·ªßa object ƒë·∫ßu ti√™n
                    const firstRow = data.data[0];
                    for (const key in firstRow) {
                        tableHtml += `<th>${key}</th>`;
                    }
                    tableHtml += '</tr></thead><tbody>';
                    
                    // Th√™m c√°c d√≤ng d·ªØ li·ªáu
                    data.data.forEach(row => {
                        tableHtml += '<tr>';
                        for (const key in row) {
                            tableHtml += `<td>${row[key]}</td>`;
                        }
                        tableHtml += '</tr>';
                    });
                    
                    tableHtml += '</tbody></table>';
                    
                    // N·∫øu l√† trang ƒë·∫ßu, thay th·∫ø b·∫£ng c≈©
                    if (page === 1) {
                        tableContainer.innerHTML = tableHtml;
                    } else {
                        // N·∫øu l√† trang ti·∫øp theo, th√™m v√†o cu·ªëi b·∫£ng hi·ªán t·∫°i
                        const currentTable = tableContainer.querySelector('table');
                        if (currentTable) {
                            const tbody = currentTable.querySelector('tbody');
                            const newRows = new DOMParser().parseFromString(tableHtml, 'text/html')
                                .querySelector('tbody').innerHTML;
                            tbody.innerHTML += newRows;
                        }
                    }
                    
                    // C·∫≠p nh·∫≠t th√¥ng tin
                    document.getElementById('showingRows').textContent = 
                        Math.min(page * rowsPerPage, totalRows);
                    currentPage = page;
                    
                    // ·∫®n n√∫t t·∫£i th√™m n·∫øu ƒë√£ hi·ªÉn th·ªã h·∫øt
                    if (page * rowsPerPage >= totalRows) {
                        document.getElementById('loadMoreContainer').style.display = 'none';
                    }
                }
                
                createPagination();
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message);
            } finally {
                loading.style.display = 'none';
                loadMoreBtn.disabled = false;
            }
        }
        
        // Kh·ªüi t·∫°o ph√¢n trang
        document.addEventListener('DOMContentLoaded', function() {
            createPagination();
            
            // ·∫®n n√∫t t·∫£i th√™m n·∫øu kh√¥ng c√≤n d·ªØ li·ªáu
            if (rowsPerPage >= totalRows) {
                document.getElementById('loadMoreContainer').style.display = 'none';
            }
        });
    </script>
    {% endif %}
</body>
</html>
